<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>AcWing SpringBoot项目实战05 | Atopos's Blog</title><meta name="keywords" content="JAVA,SpringBoot,AcWing"><meta name="author" content="Atopos·"><meta name="copyright" content="Atopos·"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="根据AcWing平台上SpringBoot框架课的学习编写，本章主要实现微服务，匹配系统的设计与实现。">
<meta property="og:type" content="article">
<meta property="og:title" content="AcWing SpringBoot项目实战05">
<meta property="og:url" content="http://example.com/2023/03/17/AcWing/SpringBoot/05Course/index.html">
<meta property="og:site_name" content="Atopos&#39;s Blog">
<meta property="og:description" content="根据AcWing平台上SpringBoot框架课的学习编写，本章主要实现微服务，匹配系统的设计与实现。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.acwing.com/media/activity/surface/springbootlesson.png">
<meta property="article:published_time" content="2023-03-17T07:23:23.000Z">
<meta property="article:modified_time" content="2023-04-01T02:39:12.195Z">
<meta property="article:author" content="Atopos·">
<meta property="article:tag" content="JAVA">
<meta property="article:tag" content="SpringBoot">
<meta property="article:tag" content="AcWing">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.acwing.com/media/activity/surface/springbootlesson.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://example.com/2023/03/17/AcWing/SpringBoot/05Course/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: {"limitDay":30,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":300},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":20,"languages":{"author":"作者: Atopos·","link":"链接: ","source":"来源: Atopos's Blog","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'mediumZoom',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'AcWing SpringBoot项目实战05',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-04-01 10:39:12'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/mycss.css"><link rel="stylesheet" href="/css/color.css"><link rel="stylesheet" href="/css/fonts.css"><!-- hexo injector head_end start --><link rel="stylesheet" href="https://unpkg.zhimg.com/hexo-butterfly-clock/lib/clock.min.css" /><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/./img/head.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data is-center"><div class="data-item"><a href="/archives/"><div class="headline">文章</div><div class="length-num">88</div></a></div><div class="data-item"><a href="/tags/"><div class="headline">标签</div><div class="length-num">57</div></a></div><div class="data-item"><a href="/categories/"><div class="headline">分类</div><div class="length-num">15</div></a></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://cdn.acwing.com/media/activity/surface/springbootlesson.png')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Atopos's Blog</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">AcWing SpringBoot项目实战05</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-03-17T07:23:23.000Z" title="发表于 2023-03-17 15:23:23">2023-03-17</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-04-01T02:39:12.195Z" title="更新于 2023-04-01 10:39:12">2023-04-01</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/AcWing/">AcWing</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/AcWing/Course/">Course</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">15.3k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>72分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="AcWing SpringBoot项目实战05"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="学习平台"><a href="#学习平台" class="headerlink" title="学习平台"></a>学习平台</h1><p><a target="_blank" rel="noopener" href="https://www.acwing.com/activity/content/introduction/1877/"> AcWing SpringBoot框架课 </a></p>
<h1 id="系统流程"><a href="#系统流程" class="headerlink" title="系统流程"></a>系统流程</h1><p><img src="/img/AcWing/SpringBoot/05Course/image-20230322200513253.png" alt="image-20230322200513253"></p>
<h1 id="改进之处"><a href="#改进之处" class="headerlink" title="改进之处"></a>改进之处</h1><p><strong>存在的问题1</strong>：之前地图的创建是在前端写的，所以如果两个用户匹配之后，在各自的前端生成地图，则生成的地图很大程度上是不一样的，这样肯定是不行的。</p>
<p><strong>解决办法</strong>：因此，在本节中，我们首先需要将生成地图这个过程放在后端中。这样当两个玩家匹配之后，需要调用一个单独的任务，这个任务会统一的给两个玩家生成地图。</p>
<p><strong>问题2</strong>：裁判逻辑，也就是判断两个玩家的输赢也不应该放在前端。</p>
<p><strong>解决办法</strong>：也需要将判断输赢这个过程放在后端，这样就可以避免恶意篡改结果。</p>
<p>前端在这个时候只是将后端的结果进行渲染展示，而不做任何判断逻辑。（并不是所有的游戏都需要将逻辑放在云端）</p>
<h1 id="环境配置"><a href="#环境配置" class="headerlink" title="环境配置"></a>环境配置</h1><h2 id="集成WebSocket"><a href="#集成WebSocket" class="headerlink" title="集成WebSocket"></a>集成WebSocket</h2><p>1.在<code>pom.xml</code>中导入依赖</p>
<ul>
<li><code>spring-boot-starter-websocket</code></li>
<li><code>fastjson</code></li>
</ul>
<p>2.添加<code>config.WebSocketConfig</code>配置类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.socket.server.standard.ServerEndpointExporter;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSocketConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> ServerEndpointExporter <span class="title function_">serverEndpointExporter</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ServerEndpointExporter</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>3.添加<code>consumer.WebSocketServer</code>类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.websocket.*;</span><br><span class="line"><span class="keyword">import</span> javax.websocket.server.PathParam;</span><br><span class="line"><span class="keyword">import</span> javax.websocket.server.ServerEndpoint;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@ServerEndpoint(&quot;/websocket/&#123;token&#125;&quot;)</span>  <span class="comment">// 注意不要以&#x27;/&#x27;结尾</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSocketServer</span> &#123;</span><br><span class="line">    <span class="meta">@OnOpen</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onOpen</span><span class="params">(Session session, <span class="meta">@PathParam(&quot;token&quot;)</span> String token)</span> &#123;</span><br><span class="line">        <span class="comment">// 建立连接</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@OnClose</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClose</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 关闭链接</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@OnMessage</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onMessage</span><span class="params">(String message, Session session)</span> &#123;</span><br><span class="line">        <span class="comment">// 从Client接收消息</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@OnError</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onError</span><span class="params">(Session session, Throwable error)</span> &#123;</span><br><span class="line">        error.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对该类进行修改补充。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kob.backend.consum;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.kob.backend.mapper.UserMapper;</span><br><span class="line"><span class="keyword">import</span> com.kob.backend.pojo.User;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.websocket.*;</span><br><span class="line"><span class="keyword">import</span> javax.websocket.server.PathParam;</span><br><span class="line"><span class="keyword">import</span> javax.websocket.server.ServerEndpoint;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ConcurrentHashMap;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 用户每建立一个连接，就会new一个新的实例，不是单例模式</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@ServerEndpoint(&quot;/websocket/&#123;token&#125;&quot;)</span>  <span class="comment">// 注意不要以&#x27;/&#x27;结尾</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSocketServer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ConcurrentHashMap&lt;Integer, WebSocketServer&gt; users = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;(); <span class="comment">// 静态变量，对所有实例都可见，公共的，只有一个</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> User user;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">Session</span> <span class="variable">session</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> UserMapper userMapper;  <span class="comment">// 静态变量访问时需要使用类名进行访问。</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setUserMapper</span><span class="params">(UserMapper userMapper)</span> &#123;</span><br><span class="line">        WebSocketServer.userMapper = userMapper;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@OnOpen</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onOpen</span><span class="params">(Session session, <span class="meta">@PathParam(&quot;token&quot;)</span> String token)</span> &#123;</span><br><span class="line">        <span class="comment">// 建立连接</span></span><br><span class="line">        <span class="built_in">this</span>.session = session;</span><br><span class="line">        System.out.println(<span class="string">&quot;connected!&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Integer</span> <span class="variable">userId</span> <span class="operator">=</span> Integer.parseInt(token);</span><br><span class="line">        <span class="built_in">this</span>.user = userMapper.selectById(userId);</span><br><span class="line">        users.put(userId, <span class="built_in">this</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@OnClose</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClose</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 关闭链接</span></span><br><span class="line">        System.out.println(<span class="string">&quot;disconnected!&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">this</span>.user != <span class="literal">null</span>) &#123;</span><br><span class="line">            users.remove(<span class="built_in">this</span>.user.getId());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@OnMessage</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onMessage</span><span class="params">(String message, Session session)</span> &#123;</span><br><span class="line">        <span class="comment">// 从Client接收消息</span></span><br><span class="line">        System.out.println(<span class="string">&quot;receive message!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@OnError</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onError</span><span class="params">(Session session, Throwable error)</span> &#123;</span><br><span class="line">        error.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendMessage</span><span class="params">(String message)</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="built_in">this</span>.session) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="built_in">this</span>.session.getBasicRemote().sendText(message);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>4.配置<code>config.SecurityConfig</code></p>
<p>需要将所有的<code>websocket</code>请求放行</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(WebSecurity web)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    web.ignoring().antMatchers(<span class="string">&quot;/websocket/**&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="前端实现"><a href="#前端实现" class="headerlink" title="前端实现"></a>前端实现</h2><ul>
<li>首先需要实现<code>store/pk.js</code>来保存用户的匹配信息<ul>
<li><code>status</code>：用来保存用户的状态，matching表示正在匹配，playing表示正在对战。其实就是控制前端展示的时匹配界面还是对战界面。</li>
<li><code>socket</code>：用来保存通过后端创建的websocket链接</li>
<li><code>opponent_username</code>：用来保存匹配的对手的用户名</li>
<li><code>opponent_photo</code>：用来保存匹配的对手的用户头像。</li>
</ul>
</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">    <span class="attr">state</span>: &#123;</span><br><span class="line">        <span class="attr">status</span>: <span class="string">&quot;matching&quot;</span>, <span class="comment">// matching 表示正在匹配，playing表示正在对战。</span></span><br><span class="line">        <span class="attr">socket</span>: <span class="literal">null</span>,</span><br><span class="line">        <span class="attr">opponent_username</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">        <span class="attr">opponent_photo</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">getters</span>: &#123;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">mutations</span>: &#123;  <span class="comment">// 用来给state赋值，相当于set(), 但是是私有的，</span></span><br><span class="line">        <span class="title function_">updateSocket</span>(<span class="params">state, socket</span>) &#123;</span><br><span class="line">            state.<span class="property">socket</span> = socket;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="title function_">updateOpponent</span>(<span class="params">state, opponent</span>) &#123;</span><br><span class="line">            state.<span class="property">opponent_username</span> = opponent.<span class="property">username</span>;</span><br><span class="line">            state.<span class="property">opponent_photo</span> = opponent.<span class="property">photo</span>;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="title function_">updateStatus</span>(<span class="params">state, status</span>) &#123;</span><br><span class="line">            state.<span class="property">status</span> = status;</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;, </span><br><span class="line">    <span class="attr">actions</span>: &#123;  <span class="comment">// 实现函数，公有函数，可以被外面调用，然后调用私有函数对变量进行赋值</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">modules</span>: &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>实现<code>views/pk/PkIndexView.vue</code>。</li>
</ul>
<p>通过挂在函数<code>onMouted</code>和卸载函数<code>onUnmouted</code>来实现websocket链接的创建和断开。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">    &lt;PlayGround&gt;</span><br><span class="line">        对战</span><br><span class="line">    &lt;/PlayGround&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line"></span><br><span class="line">import PlayGround from &#x27;@/components/PlayGround.vue&#x27;</span><br><span class="line">import &#123; onMounted, onUnmounted &#125; from &#x27;vue&#x27;;</span><br><span class="line">import &#123; useStore &#125; from &#x27;vuex&#x27;;</span><br><span class="line"></span><br><span class="line">export default &#123;</span><br><span class="line">    components: &#123;</span><br><span class="line">        PlayGround</span><br><span class="line">    &#125;,</span><br><span class="line">    setup() &#123;</span><br><span class="line">        const store = useStore();</span><br><span class="line">        const socketUrl = `ws://127.0.0.1:3000/websocket/$&#123;store.state.user.id&#125;/`;</span><br><span class="line"></span><br><span class="line">        let socket = null;</span><br><span class="line">        onMounted(() =&gt; &#123;  // 挂载函数，页面打开时，会执行，创建一个websocket链接</span><br><span class="line">            store.commit(&quot;updateOpponent&quot;, &#123;</span><br><span class="line">                username: &quot;我的对手&quot;,</span><br><span class="line">                photo: &quot;https://cdn.acwing.com/media/article/image/2022/08/09/1_1db2488f17-anonymous.png&quot;,</span><br><span class="line">            &#125;);</span><br><span class="line">            socket = new WebSocket(socketUrl);</span><br><span class="line"></span><br><span class="line">            socket.onopen = () =&gt; &#123;</span><br><span class="line">                console.log(&quot;connected!&quot;);</span><br><span class="line">                store.commit(&quot;updateSocket&quot;, socket);  // 将创建的socket保存</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            socket.onmessage = msg =&gt; &#123;</span><br><span class="line">                const data = JSON.parse(msg.data);</span><br><span class="line">                console.log(data);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            socket.onclose = () =&gt; &#123;</span><br><span class="line">                console.log(&quot;disconnected!&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        onUnmounted(() =&gt; &#123;  // 卸载函数，离开页面时调用，需要将websocket链接断开，避免冗余链接</span><br><span class="line">            socket.close();</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style scoped&gt;</span><br><span class="line"></span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>
<h2 id="验证jwt"><a href="#验证jwt" class="headerlink" title="验证jwt"></a>验证<code>jwt</code></h2><p>这部分属于对前面部分的优化，前面向后端发送<code>socket</code>请求时直接将用户的<code>id</code>传了过去，这样不安全，因此需要将此改为传用户的<code>token</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">	const socketUrl = `ws://127.0.0.1:3000/websocket/$&#123;store.state.user.token&#125;/`;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<p>同样需要在后端对前端传过来的token进行验证并取出所需要的userId</p>
<ul>
<li>实现<code>consumer/utils/JwtAuthentication.java</code>来验证token并返回用户id.</li>
</ul>
<p>这里实现的时静态方法。因此调用的时候直接通过<code>类名.方法名</code>调用即可。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kob.backend.consumer.utils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.kob.backend.utils.JwtUtil;</span><br><span class="line"><span class="keyword">import</span> io.jsonwebtoken.Claims;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> xzt</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * 进行Jwt验证</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JwtAuthentication</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 静态方法：根据token获取用户的userId</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> token</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Integer <span class="title function_">getUserId</span><span class="params">(String token)</span> &#123;</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">userId</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Claims</span> <span class="variable">claims</span> <span class="operator">=</span> JwtUtil.parseJWT(token);</span><br><span class="line">            userId = Integer.parseInt(claims.getSubject());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> userId;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>修改<code>consumer/WebSocketServer.java</code>中的<code>onOpen</code>函数，实现从上面的方法中获取用户名。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@OnOpen</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onOpen</span><span class="params">(Session session, <span class="meta">@PathParam(&quot;token&quot;)</span> String token)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="comment">// 建立连接</span></span><br><span class="line">    <span class="built_in">this</span>.session = session;</span><br><span class="line">    System.out.println(<span class="string">&quot;connected!&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">Integer</span> <span class="variable">userId</span> <span class="operator">=</span> JwtAuthentication.getUserId(token); <span class="comment">// 验证token并返回用户id</span></span><br><span class="line">    <span class="built_in">this</span>.user = userMapper.selectById(userId);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">this</span>.user != <span class="literal">null</span>) &#123;  <span class="comment">// 如果用户存在，将用户链接保存在users中。</span></span><br><span class="line">        users.put(userId, <span class="built_in">this</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.session.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="匹配界面前端实现"><a href="#匹配界面前端实现" class="headerlink" title="匹配界面前端实现"></a>匹配界面前端实现</h1><h2 id="界面布局"><a href="#界面布局" class="headerlink" title="界面布局"></a>界面布局</h2><p><img src="/img/AcWing/SpringBoot/05Course/image-20230320113957463.png" alt="image-20230320113957463"></p>
<h2 id="前端实现-1"><a href="#前端实现-1" class="headerlink" title="前端实现"></a>前端实现</h2><h3 id="实现步骤"><a href="#实现步骤" class="headerlink" title="实现步骤"></a>实现步骤</h3><ul>
<li>首先实现匹配页面<code>components/MatchGround.vue</code><ul>
<li>需要注意的细节：当按下【开始匹配】按钮后，需要讲该按钮变为【取消匹配】，按下【取消匹配】按钮后，则需要讲按钮变为【开始匹配】</li>
<li>当开始匹配时，需要使用socket向后端发送一个<code>event</code>为<code>start-matching</code>。取消匹配时，也需要向后端发送一个消息event为<code>stop-matching</code></li>
</ul>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">    &lt;div class=&quot;matchground&quot;&gt;</span><br><span class="line">        &lt;div class=&quot;row&quot;&gt;</span><br><span class="line">            &lt;div class=&quot;col-6&quot;&gt;</span><br><span class="line">                &lt;div class=&quot;user-photo&quot;&gt;</span><br><span class="line">                    &lt;img :src=&quot;$store.state.user.photo&quot; alt=&quot;&quot;&gt;</span><br><span class="line">                &lt;/div&gt;</span><br><span class="line">                &lt;div class=&quot;user-username&quot;&gt;</span><br><span class="line">                    &#123;&#123; $store.state.user.username &#125;&#125;</span><br><span class="line">                &lt;/div&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">            &lt;div class=&quot;col-6&quot;&gt;</span><br><span class="line">                &lt;div class=&quot;user-photo&quot;&gt;</span><br><span class="line">                    &lt;img :src=&quot;$store.state.pk.opponent_photo&quot; alt=&quot;&quot;&gt;</span><br><span class="line">                &lt;/div&gt;</span><br><span class="line">                &lt;div class=&quot;user-username&quot;&gt;</span><br><span class="line">                    &#123;&#123; $store.state.pk.opponent_username &#125;&#125;</span><br><span class="line">                &lt;/div&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">            &lt;div class=&quot;col-12&quot; style=&quot;text-align: center; padding-top: 15vh;&quot;&gt;</span><br><span class="line">                &lt;button @click=&quot;click_match_btn&quot; type=&quot;button&quot; class=&quot;btn btn-warning btn-lg&quot;&gt;&#123;&#123; match_btn_info &#125;&#125;&lt;/button&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">import &#123; ref &#125; from &#x27;vue&#x27;</span><br><span class="line">import &#123; useStore &#125; from &#x27;vuex&#x27;;</span><br><span class="line"></span><br><span class="line">export default &#123;</span><br><span class="line">    setup() &#123;</span><br><span class="line">        const store = useStore();</span><br><span class="line">        let match_btn_info = ref(&quot;开始匹配&quot;);</span><br><span class="line"></span><br><span class="line">        const click_match_btn = () =&gt; &#123;</span><br><span class="line">            if(match_btn_info.value === &quot;开始匹配&quot;) &#123;</span><br><span class="line">                match_btn_info.value =&quot;取消匹配&quot;;</span><br><span class="line">                store.state.pk.socket.send(JSON.stringify(&#123;</span><br><span class="line">                    event: &quot;start-matching&quot;,</span><br><span class="line">                &#125;));</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                match_btn_info.value = &quot;开始匹配&quot;;</span><br><span class="line">                store.state.pk.socket.send(JSON.stringify(&#123;</span><br><span class="line">                    event: &quot;stop-matching&quot;,</span><br><span class="line">                &#125;));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return &#123;</span><br><span class="line">            match_btn_info,</span><br><span class="line">            click_match_btn,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style scoped&gt;</span><br><span class="line">    div.matchground&#123;</span><br><span class="line">        width: 60vw;</span><br><span class="line">        height: 70vh;</span><br><span class="line">        background-color: rgba(50, 50, 50, 0.5);</span><br><span class="line">        margin: 40px auto 0;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    div.user-photo&#123;</span><br><span class="line">        text-align: center;</span><br><span class="line">        padding-top: 10vh;</span><br><span class="line">    &#125;</span><br><span class="line">    div.user-photo &gt; img &#123;</span><br><span class="line">        border-radius: 50%;</span><br><span class="line">        width: 20vh;</span><br><span class="line">    &#125;</span><br><span class="line">    div.user-username&#123;</span><br><span class="line">        text-align: center;</span><br><span class="line">        font-size: 24px;</span><br><span class="line">        font-weight: 600;</span><br><span class="line">        color: white;</span><br><span class="line">        padding-top: 2vh;</span><br><span class="line">    &#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>
<ul>
<li>修改Pk主页面<code>views/pk/PkIndexView.vue</code>，当没有匹配成功时显示匹配页面<code>MatchGround.vue</code>，当匹配成功后显示对战页面<code>PlayGround.vue</code></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">	&lt;PlayGround v-if=&quot;$store.state.pk.status === &#x27;playing&#x27;&quot;&gt;&lt;/PlayGround&gt;</span><br><span class="line">    &lt;MatchGround v-if=&quot;$store.state.pk.status === &#x27;matching&#x27;&quot;&gt;&lt;/MatchGround&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">import MatchGround from &#x27;@/components/MatchGround.vue&#x27;;</span><br><span class="line"></span><br><span class="line">  export default &#123;</span><br><span class="line">    components: &#123;</span><br><span class="line">        PlayGround,</span><br><span class="line">        MatchGround,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<h3 id="实现效果"><a href="#实现效果" class="headerlink" title="实现效果"></a>实现效果</h3><p><img src="/img/AcWing/SpringBoot/05Course/image-20230321090757277.png" alt="image-20230321090757277"></p>
<p>点击开始匹配后：按钮变为取消匹配</p>
<p><img src="/img/AcWing/SpringBoot/05Course/image-20230321090813440.png" alt="image-20230321090813440"></p>
<h1 id="匹配界面后端实现"><a href="#匹配界面后端实现" class="headerlink" title="匹配界面后端实现"></a>匹配界面后端实现</h1><h2 id="实现步骤-1"><a href="#实现步骤-1" class="headerlink" title="实现步骤"></a>实现步骤</h2><ul>
<li>首先在<code>consumer/WebSocketServer</code>中修改<code>onMessage</code>函数，用来接收前端发送的字符串<code>event</code><ul>
<li>当event为<code>start-matching</code>时，调用<code>startMatching()</code>函数</li>
<li>当event为<code>stop-matching</code>时，调用<code>stopMatching()</code>函数</li>
</ul>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@OnMessage</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onMessage</span><span class="params">(String message, Session session)</span> &#123;</span><br><span class="line">    <span class="comment">// 从Client接收消息</span></span><br><span class="line">    System.out.println(<span class="string">&quot;receive message!&quot;</span>);</span><br><span class="line">    <span class="comment">// 从json中取出前端传的event</span></span><br><span class="line">    <span class="type">JSONObject</span> <span class="variable">data</span> <span class="operator">=</span> JSONObject.parseObject(message);</span><br><span class="line">    <span class="type">String</span> <span class="variable">event</span> <span class="operator">=</span> data.getString(<span class="string">&quot;event&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="string">&quot;start-matching&quot;</span>.equals(event)) &#123;</span><br><span class="line">        startMatching();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="string">&quot;stop-matching&quot;</span>.equals(event)) &#123;</span><br><span class="line">        stopMatching();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>在<code>consumer/WebSocketServer</code>开一个线程池，用来保存所有正在匹配的用户信息。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="keyword">private</span> <span class="keyword">static</span> CopyOnWriteArrayList&lt;User&gt; matchpool = <span class="keyword">new</span> <span class="title class_">CopyOnWriteArrayList</span>&lt;&gt;();  <span class="comment">// 开一个线程池,线程安全</span></span><br></pre></td></tr></table></figure>
<ul>
<li>修改<code>onClose</code>函数，当关闭连接时需要讲用户信息从线程池中移除。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@OnClose</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClose</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 关闭链接</span></span><br><span class="line">    System.out.println(<span class="string">&quot;disconnected!&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">this</span>.user != <span class="literal">null</span>) &#123;</span><br><span class="line">        users.remove(<span class="built_in">this</span>.user.getId());</span><br><span class="line">        matchpool.remove(<span class="built_in">this</span>.user);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>简单实现<code>startMatching</code>和<code>stopMatching</code>，开始匹配时将用户信息加入匹配池，取消匹配的时候，讲用户从匹配池中移除。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">startMatching</span><span class="params">()</span> &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;start matching&quot;</span>);</span><br><span class="line">    matchpool.add(<span class="built_in">this</span>.user);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">stopMatching</span><span class="params">()</span> &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;stop matching&quot;</span>);</span><br><span class="line">    matchpool.remove(<span class="built_in">this</span>.user);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="实现傻瓜式匹配"><a href="#实现傻瓜式匹配" class="headerlink" title="实现傻瓜式匹配"></a>实现傻瓜式匹配</h2><h3 id="实现步骤-2"><a href="#实现步骤-2" class="headerlink" title="实现步骤"></a>实现步骤</h3><p>具体思路：当线程池中的用户数量大于等于2时，讲用户两两匹配，这里之所以为傻瓜式匹配，就是没考虑战力rating的差距。</p>
<ul>
<li>修改<code>consumer/WebSocketServer</code>中的<code>startMatching</code>函数</li>
</ul>
<p>匹配成功后，需要向前端发送消息。包括匹配成功的信息，和对手的相关信息。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">startMatching</span><span class="params">()</span> &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;start matching&quot;</span>);</span><br><span class="line">    matchpool.add(<span class="built_in">this</span>.user);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(matchpool.size() &gt;= <span class="number">2</span>) &#123;</span><br><span class="line">        Iterator&lt;User&gt; it = matchpool.iterator();</span><br><span class="line">        <span class="type">User</span> <span class="variable">a</span> <span class="operator">=</span> it.next(), b = it.next();</span><br><span class="line">        matchpool.remove(a);</span><br><span class="line">        matchpool.remove(b);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 往前端传递匹配成功的信息</span></span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">respA</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line">        respA.put(<span class="string">&quot;event&quot;</span>, <span class="string">&quot;success-matching&quot;</span>);</span><br><span class="line">        respA.put(<span class="string">&quot;opponent_username&quot;</span>, b.getUsername());</span><br><span class="line">        respA.put(<span class="string">&quot;opponent_photo&quot;</span>, b.getPhoto());</span><br><span class="line">        <span class="comment">// 获取A的webSocket，并向前端发送信息</span></span><br><span class="line">        <span class="type">WebSocketServer</span> <span class="variable">webSocketServerA</span> <span class="operator">=</span> users.get(a.getId());</span><br><span class="line">        webSocketServerA.sendMessage(respA.toJSONString());</span><br><span class="line"></span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">respB</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line">        respB.put(<span class="string">&quot;event&quot;</span>, <span class="string">&quot;success-matching&quot;</span>);</span><br><span class="line">        respB.put(<span class="string">&quot;opponent_username&quot;</span>, a.getUsername());</span><br><span class="line">        respB.put(<span class="string">&quot;opponent_photo&quot;</span>, a.getPhoto());</span><br><span class="line">        <span class="comment">//获取B的webSocket并向前端发送信息</span></span><br><span class="line">        users.get(b.getId()).sendMessage(respB.toJSONString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>前端实现，在<code>views/pk/PkIndexView.vue</code>中修改<code>onMouted</code>挂载函数中的<code>socket.message</code></li>
<li>当Pk页面被卸载时，需要将状态重新改为<code>matching</code>，需要重新匹配。修改<code>onUnmounted</code></li>
</ul>
<p>当接收到后端发送的<code>event</code>为<code>success-matching</code>时，则表示匹配成功，则需要调用<code>store</code>中的函数将对手信息保存下来。然后在2000ms后将状态修改为<code>playing</code>就可以跳转到对战页面。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">    onMounted(() =&gt; &#123;  // 挂载函数，页面打开时，会执行，创建一个websocket链接</span><br><span class="line">        store.commit(&quot;updateOpponent&quot;, &#123;</span><br><span class="line">            username: &quot;我的对手&quot;,</span><br><span class="line">            photo: &quot;https://cdn.acwing.com/media/article/image/2022/08/09/1_1db2488f17-anonymous.png&quot;,</span><br><span class="line">        &#125;);</span><br><span class="line">        socket = new WebSocket(socketUrl);</span><br><span class="line"></span><br><span class="line">        socket.onopen = () =&gt; &#123;</span><br><span class="line">            console.log(&quot;connected!&quot;);</span><br><span class="line">            store.commit(&quot;updateSocket&quot;, socket);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        socket.onmessage = msg =&gt; &#123;</span><br><span class="line">            const data = JSON.parse(msg.data);</span><br><span class="line">            if(data.event === &quot;success-matching&quot;) &#123;  // 表示匹配成功</span><br><span class="line">                store.commit(&quot;updateOpponent&quot;, &#123;</span><br><span class="line">                    username: data.opponent_username,</span><br><span class="line">                    photo: data.opponent_photo,</span><br><span class="line">                &#125;);</span><br><span class="line">                setTimeout(() =&gt; &#123;</span><br><span class="line">                    store.commit(&quot;updateStatus&quot;, &quot;playing&quot;);</span><br><span class="line">                &#125;, 2000);</span><br><span class="line">            &#125;</span><br><span class="line">            console.log(data);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        socket.onclose = () =&gt; &#123;</span><br><span class="line">            console.log(&quot;disconnected!&quot;);</span><br><span class="line">            store.commit(&quot;updateStatus&quot;, &quot;matching&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    onUnmounted(() =&gt; &#123;  // 卸载函数，离开页面时调用，需要将websocket链接断开，避免冗余链接</span><br><span class="line">        socket.close();</span><br><span class="line">        store.commit(&quot;updateStatus&quot;, &quot;matching&quot;);</span><br><span class="line">    &#125;);</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<h3 id="实现效果-1"><a href="#实现效果-1" class="headerlink" title="实现效果"></a>实现效果</h3><p>当匹配成功后，会显示对手的头像和用户名信息。</p>
<p><img src="/img/AcWing/SpringBoot/05Course/image-20230321101122841.png" alt="image-20230321101122841"></p>
<p>然后跳转到对战页面，但是因为地图实现还在前端，所以两个玩家的地图不一致。因此后面就需要针对这个内容进行优化，将地图生成放在后端实现。</p>
<p><img src="/img/AcWing/SpringBoot/05Course/image-20230321101159842.png" alt="image-20230321101159842"></p>
<h2 id="生成地图优化（同步）"><a href="#生成地图优化（同步）" class="headerlink" title="生成地图优化（同步）"></a>生成地图优化（同步）</h2><p>需要将地图生成放在后端，这样可以保证两个玩家使用的是同一张地图。</p>
<h3 id="实现步骤-3"><a href="#实现步骤-3" class="headerlink" title="实现步骤"></a>实现步骤</h3><ul>
<li>将地图生成的逻辑转移至后端<code>consumer/utils/Game.java</code>中</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kob.backend.consumer.utils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> xzt</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * 用来生成地图</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Game</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">private</span> Integer rows;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">private</span> Integer cols;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">private</span> Integer inner_walls_count;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">private</span> <span class="type">int</span>[][] g;  <span class="comment">// 0表示空地，1表示障碍物</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span>[] dx = &#123;-<span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>&#125;, dy = &#123;<span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, -<span class="number">1</span>&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Game</span><span class="params">(Integer rows, Integer cols, Integer inner_walls_count)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.rows = rows;</span><br><span class="line">        <span class="built_in">this</span>.cols = cols;</span><br><span class="line">        <span class="built_in">this</span>.inner_walls_count = inner_walls_count;</span><br><span class="line">        <span class="built_in">this</span>.g = <span class="keyword">new</span> <span class="title class_">int</span>[rows][cols];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 返回地图</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span>[][] getG() &#123;</span><br><span class="line">        <span class="keyword">return</span> g;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 判断地图的连通性</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> sx 起始横坐标</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> sy 起始纵坐标</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> tx 目标横坐标</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ty 目标纵坐标</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> true表示连通，false表示不连通</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">check_connectivity</span><span class="params">(<span class="type">int</span> sx, <span class="type">int</span> sy, <span class="type">int</span> tx, <span class="type">int</span> ty)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(sx == tx &amp;&amp; sy == ty) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        g[sx][sy] = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">4</span>; i++) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">x</span> <span class="operator">=</span> sx + dx[i];</span><br><span class="line">            <span class="type">int</span> <span class="variable">y</span> <span class="operator">=</span> sy + dy[i];</span><br><span class="line">            <span class="keyword">if</span>(x &gt;= <span class="number">0</span> &amp;&amp; x &lt; <span class="built_in">this</span>.rows &amp;&amp; y &gt;= <span class="number">0</span> &amp;&amp; y &lt; <span class="built_in">this</span>.cols &amp;&amp; g[x][y] == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span>(check_connectivity(x, y, tx, ty)) &#123;</span><br><span class="line">                    g[sx][sy] = <span class="number">0</span>;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        g[sx][sy] = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 画地图</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">draw</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 将地图初始化</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="built_in">this</span>.rows; i++) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; <span class="built_in">this</span>.cols; j++) &#123;</span><br><span class="line">                g[i][j] = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 给四周加墙</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">r</span> <span class="operator">=</span> <span class="number">0</span>; r &lt; <span class="built_in">this</span>.rows; r++) &#123;</span><br><span class="line">            g[r][<span class="number">0</span>] = g[r][<span class="built_in">this</span>.cols - <span class="number">1</span>] = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> <span class="number">0</span>; c &lt; <span class="built_in">this</span>.cols; c++) &#123;</span><br><span class="line">            g[<span class="number">0</span>][c] = g[<span class="built_in">this</span>.rows - <span class="number">1</span>][c] = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建随机障碍物</span></span><br><span class="line">        <span class="type">Random</span> <span class="variable">random</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="built_in">this</span>.inner_walls_count / <span class="number">2</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; <span class="number">1000</span>; j++) &#123;</span><br><span class="line">                <span class="type">int</span> <span class="variable">r</span> <span class="operator">=</span> random.nextInt(<span class="built_in">this</span>.rows);  <span class="comment">// 返回0~this.rows-1中的一个随机值</span></span><br><span class="line">                <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> random.nextInt(<span class="built_in">this</span>.cols);</span><br><span class="line">                <span class="keyword">if</span>(g[r][c] == <span class="number">1</span> || g[<span class="built_in">this</span>.rows - <span class="number">1</span> - r][<span class="built_in">this</span>.cols - <span class="number">1</span> - c] == <span class="number">1</span>) <span class="keyword">continue</span>;</span><br><span class="line">                <span class="keyword">if</span>(r == <span class="built_in">this</span>.rows - <span class="number">2</span> &amp;&amp; c == <span class="number">1</span> || r == <span class="number">1</span> &amp;&amp; c == <span class="built_in">this</span>.cols - <span class="number">2</span>) <span class="keyword">continue</span>;</span><br><span class="line">                g[r][c] = g[<span class="built_in">this</span>.rows - <span class="number">1</span> - r][<span class="built_in">this</span>.cols - <span class="number">1</span> - c] = <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 判断连通性</span></span><br><span class="line">        <span class="keyword">return</span> check_connectivity(<span class="built_in">this</span>.rows - <span class="number">2</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="built_in">this</span>.cols - <span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建地图</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">createMap</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span>(draw()) <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li>在<code>WebSocketServer</code>中匹配成功后，调用<code>Game</code>类中的<code>createMap()</code>函数，进行地图生成。并将生成的地图分别传给两个玩家的前端。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">startMatching</span><span class="params">()</span> &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;start matching&quot;</span>);</span><br><span class="line">    matchpool.add(<span class="built_in">this</span>.user);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(matchpool.size() &gt;= <span class="number">2</span>) &#123;</span><br><span class="line">        Iterator&lt;User&gt; it = matchpool.iterator();</span><br><span class="line">        <span class="type">User</span> <span class="variable">a</span> <span class="operator">=</span> it.next(), b = it.next();</span><br><span class="line">        matchpool.remove(a);</span><br><span class="line">        matchpool.remove(b);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 生成地图</span></span><br><span class="line">        <span class="type">Game</span> <span class="variable">game</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Game</span>(<span class="number">13</span>, <span class="number">14</span>, <span class="number">20</span>);</span><br><span class="line">        game.createMap();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 往前端传递匹配成功的信息</span></span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">respA</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line">        respA.put(<span class="string">&quot;event&quot;</span>, <span class="string">&quot;success-matching&quot;</span>);</span><br><span class="line">        respA.put(<span class="string">&quot;opponent_username&quot;</span>, b.getUsername());</span><br><span class="line">        respA.put(<span class="string">&quot;opponent_photo&quot;</span>, b.getPhoto());</span><br><span class="line">        respA.put(<span class="string">&quot;gamemap&quot;</span>, game.getG());</span><br><span class="line">        <span class="comment">// 获取A的webSocket，并向前端发送信息</span></span><br><span class="line">        <span class="type">WebSocketServer</span> <span class="variable">webSocketServerA</span> <span class="operator">=</span> users.get(a.getId());</span><br><span class="line">        webSocketServerA.sendMessage(respA.toJSONString());</span><br><span class="line"></span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">respB</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line">        respB.put(<span class="string">&quot;event&quot;</span>, <span class="string">&quot;success-matching&quot;</span>);</span><br><span class="line">        respB.put(<span class="string">&quot;opponent_username&quot;</span>, a.getUsername());</span><br><span class="line">        respB.put(<span class="string">&quot;opponent_photo&quot;</span>, a.getPhoto());</span><br><span class="line">        respB.put(<span class="string">&quot;gamemap&quot;</span>, game.getG());</span><br><span class="line">        <span class="comment">//获取B的webSocket并向前端发送信息</span></span><br><span class="line">        users.get(b.getId()).sendMessage(respB.toJSONString());</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>在<code>store/pk.js</code>中引入一个变量<code>gamemap</code>,并实现对应的赋值函数<code>updateGamemap</code>。</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">    <span class="attr">state</span>: &#123;</span><br><span class="line">        <span class="attr">status</span>: <span class="string">&quot;matching&quot;</span>, <span class="comment">// matching 表示正在匹配，playing表示正在对战。</span></span><br><span class="line">        <span class="attr">socket</span>: <span class="literal">null</span>,</span><br><span class="line">        <span class="attr">opponent_username</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">        <span class="attr">opponent_photo</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">        <span class="attr">gamemap</span>: <span class="literal">null</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">getters</span>: &#123;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">mutations</span>: &#123;  <span class="comment">// 用来给state赋值，相当于set(), 但是是私有的，</span></span><br><span class="line">        <span class="title function_">updateSocket</span>(<span class="params">state, socket</span>) &#123;</span><br><span class="line">            state.<span class="property">socket</span> = socket;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="title function_">updateOpponent</span>(<span class="params">state, opponent</span>) &#123;</span><br><span class="line">            state.<span class="property">opponent_username</span> = opponent.<span class="property">username</span>;</span><br><span class="line">            state.<span class="property">opponent_photo</span> = opponent.<span class="property">photo</span>;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="title function_">updateStatus</span>(<span class="params">state, status</span>) &#123;</span><br><span class="line">            state.<span class="property">status</span> = status;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="title function_">updateGamemap</span>(<span class="params">state, gamemap</span>) &#123;</span><br><span class="line">            state.<span class="property">gamemap</span> = gamemap;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, </span><br><span class="line">    <span class="attr">actions</span>: &#123;  <span class="comment">// 实现函数，公有函数，可以被外面调用，然后调用私有函数对变量进行赋值</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">modules</span>: &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>修改<code>views/pk/PkIndexView.vue</code>中的<code>socket.message</code>函数。当匹配成功后需要接受后端发送过来的地图信息，并调用<code>updateGamemap</code>函数对<code>pk.js</code>中保存的地图信息进行更新。</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">    socket.onmessage = msg =&gt; &#123;</span><br><span class="line">        const data = JSON.parse(msg.data);</span><br><span class="line">        if(data.event === &quot;success-matching&quot;) &#123;  // 表示匹配成功</span><br><span class="line">            store.commit(&quot;updateOpponent&quot;, &#123;</span><br><span class="line">                username: data.opponent_username,</span><br><span class="line">                photo: data.opponent_photo,</span><br><span class="line">            &#125;);</span><br><span class="line">            setTimeout(() =&gt; &#123;</span><br><span class="line">                store.commit(&quot;updateStatus&quot;, &quot;playing&quot;);</span><br><span class="line">            &#125;, 2000);</span><br><span class="line">            store.commit(&quot;updateGamemap&quot;, data.gamemap);</span><br><span class="line">        &#125;</span><br><span class="line">        console.log(data);</span><br><span class="line">    &#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<ul>
<li>将前端写的生成地图的逻辑代码删除；修改<code>scripts/GameMap.js</code>，需要在构造函数中传入store，用来接收地图信息。<ul>
<li>新加<code>this.store = store</code></li>
<li>删除原来的判断连通性函数，因为在后端实现的时候就判断了</li>
<li>修改<code>create_walls</code>函数，只用来将<code>g</code>中的信息绘制出来</li>
<li>修改start()函数，不用循环1000次直到找到连通性的地图才结束。因为后端传过来的地图已经保证了连通性。</li>
</ul>
</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">AcGameObject</span> &#125; <span class="keyword">from</span> <span class="string">&quot;./AcGameObject&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Snake</span> &#125; <span class="keyword">from</span> <span class="string">&quot;./Snake&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Wall</span> &#125; <span class="keyword">from</span> <span class="string">&quot;./Wall&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">GameMap</span> <span class="keyword">extends</span> <span class="title class_ inherited__">AcGameObject</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">ctx, parent, store</span>) &#123;</span><br><span class="line">        <span class="variable language_">super</span>(); <span class="comment">// 执行基类的构造函数，就是AcGameObject的构造函数</span></span><br><span class="line"></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">ctx</span> = ctx;  <span class="comment">// 一个画布</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">parent</span> = parent;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">store</span> = store; </span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">L</span> = <span class="number">0</span>;  <span class="comment">// 表示地图中每一个小块的宽度</span></span><br><span class="line"></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">rows</span> = <span class="number">13</span>;  <span class="comment">// 地图的行数</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">cols</span> = <span class="number">14</span>;  <span class="comment">// 地图的列数</span></span><br><span class="line"></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">walls</span> = [];  <span class="comment">// 保存创建的每个障碍物的对象</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">inner_walls_count</span> = <span class="number">20</span>; <span class="comment">// 定义在地图里面障碍物数量</span></span><br><span class="line"></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">snakes</span> = [</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Snake</span>(&#123;<span class="attr">id</span>: <span class="number">0</span>, <span class="attr">color</span>: <span class="string">&quot;#4876EC&quot;</span>, <span class="attr">r</span>: <span class="variable language_">this</span>.<span class="property">rows</span> - <span class="number">2</span>, <span class="attr">c</span>: <span class="number">1</span>&#125;, <span class="variable language_">this</span>),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Snake</span>(&#123;<span class="attr">id</span>: <span class="number">1</span>, <span class="attr">color</span>: <span class="string">&quot;#F94848&quot;</span>, <span class="attr">r</span>: <span class="number">1</span>, <span class="attr">c</span>: <span class="variable language_">this</span>.<span class="property">cols</span> - <span class="number">2</span>&#125;, <span class="variable language_">this</span>),</span><br><span class="line">        ];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="title function_">create_walls</span>(<span class="params"></span>) &#123;</span><br><span class="line">       <span class="keyword">const</span> g = <span class="variable language_">this</span>.<span class="property">store</span>.<span class="property">state</span>.<span class="property">pk</span>.<span class="property">gamemap</span>; <span class="comment">// 从PK.js中取出后端保存的地图</span></span><br><span class="line">        <span class="comment">// 绘制墙</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">let</span> r = <span class="number">0</span>; r &lt; <span class="variable language_">this</span>.<span class="property">rows</span>; r ++) &#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">let</span> c = <span class="number">0</span>; c &lt; <span class="variable language_">this</span>.<span class="property">cols</span>; c ++) &#123;</span><br><span class="line">                <span class="keyword">if</span>(g[r][c]) </span><br><span class="line">                    <span class="variable language_">this</span>.<span class="property">walls</span>.<span class="title function_">push</span>(<span class="keyword">new</span> <span class="title class_">Wall</span>(r, c, <span class="variable language_">this</span>));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">add_listening_events</span>(<span class="params"></span>) &#123;  <span class="comment">// 监听 用户输入</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">canvas</span>.<span class="title function_">focus</span>(); <span class="comment">// 添加 canvas 聚焦</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> [snake0, snake1] = <span class="variable language_">this</span>.<span class="property">snakes</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">canvas</span>.<span class="title function_">addEventListener</span>(<span class="string">&quot;keydown&quot;</span>, <span class="function"><span class="params">e</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span>(e.<span class="property">key</span> === <span class="string">&#x27;w&#x27;</span>) snake0.<span class="title function_">set_direction</span>(<span class="number">0</span>);</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(e.<span class="property">key</span> === <span class="string">&#x27;d&#x27;</span>) snake0.<span class="title function_">set_direction</span>(<span class="number">1</span>);</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(e.<span class="property">key</span> === <span class="string">&#x27;s&#x27;</span>) snake0.<span class="title function_">set_direction</span>(<span class="number">2</span>);</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(e.<span class="property">key</span> === <span class="string">&#x27;a&#x27;</span>) snake0.<span class="title function_">set_direction</span>(<span class="number">3</span>);</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(e.<span class="property">key</span> === <span class="string">&#x27;ArrowUp&#x27;</span>) snake1.<span class="title function_">set_direction</span>(<span class="number">0</span>);</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(e.<span class="property">key</span> === <span class="string">&#x27;ArrowRight&#x27;</span>) snake1.<span class="title function_">set_direction</span>(<span class="number">1</span>);</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(e.<span class="property">key</span> === <span class="string">&#x27;ArrowDown&#x27;</span>) snake1.<span class="title function_">set_direction</span>(<span class="number">2</span>);</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(e.<span class="property">key</span> === <span class="string">&#x27;ArrowLeft&#x27;</span>) snake1.<span class="title function_">set_direction</span>(<span class="number">3</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">start</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">create_walls</span>();</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">add_listening_events</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">update_size</span>(<span class="params"></span>) &#123;  <span class="comment">// 更新地图的大小</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">L</span> = <span class="built_in">parseInt</span>(<span class="title class_">Math</span>.<span class="title function_">min</span>(<span class="variable language_">this</span>.<span class="property">parent</span>.<span class="property">clientWidth</span> / <span class="variable language_">this</span>.<span class="property">cols</span>, <span class="variable language_">this</span>.<span class="property">parent</span>.<span class="property">clientHeight</span> / <span class="variable language_">this</span>.<span class="property">rows</span>));</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">canvas</span>.<span class="property">width</span> = <span class="variable language_">this</span>.<span class="property">L</span> * <span class="variable language_">this</span>.<span class="property">cols</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">canvas</span>.<span class="property">height</span> = <span class="variable language_">this</span>.<span class="property">L</span> * <span class="variable language_">this</span>.<span class="property">rows</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">check_ready</span>(<span class="params"></span>) &#123;  <span class="comment">// 判断两条蛇是否都准备好下一回合</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">const</span> snake <span class="keyword">of</span> <span class="variable language_">this</span>.<span class="property">snakes</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span>(snake.<span class="property">status</span> !== <span class="string">&quot;idle&quot;</span>) <span class="keyword">return</span> <span class="literal">false</span>;  <span class="comment">// 不是静止，不能进入下一回合</span></span><br><span class="line">            <span class="keyword">if</span>(snake.<span class="property">direction</span> === -<span class="number">1</span>) <span class="keyword">return</span> <span class="literal">false</span>;   <span class="comment">// 没有给出下一步的指令，则不能进入下一回合</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">next_step</span>(<span class="params"></span>) &#123; <span class="comment">// 让两条蛇进入下一回合</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">const</span> snake <span class="keyword">of</span> <span class="variable language_">this</span>.<span class="property">snakes</span>) &#123;</span><br><span class="line">            snake.<span class="title function_">next_step</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">check_valid</span>(<span class="params">cell</span>) &#123;  <span class="comment">// 检测目标位置是否合法： 没有撞到两条蛇的身体，或者障碍物</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">const</span> wall <span class="keyword">of</span> <span class="variable language_">this</span>.<span class="property">walls</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span>(wall.<span class="property">r</span> === cell.<span class="property">r</span> &amp;&amp; wall.<span class="property">c</span> === cell.<span class="property">c</span>) <span class="keyword">return</span> <span class="literal">false</span>;  <span class="comment">// 如果下一位置是障碍物</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">const</span> snake <span class="keyword">of</span> <span class="variable language_">this</span>.<span class="property">snakes</span>) &#123;</span><br><span class="line">            <span class="keyword">let</span> k = snake.<span class="property">cells</span>.<span class="property">length</span>;</span><br><span class="line">            <span class="keyword">if</span>(!snake.<span class="title function_">check_tail_increasing</span>()) &#123;  <span class="comment">// 当蛇尾会前进的时候</span></span><br><span class="line">                k --;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; k; i ++) &#123;  <span class="comment">// 遍历蛇的每个节点，判断是否会装上。</span></span><br><span class="line">                <span class="keyword">if</span>(snake.<span class="property">cells</span>[i].<span class="property">r</span> === cell.<span class="property">r</span> &amp;&amp; snake.<span class="property">cells</span>[i].<span class="property">c</span> === cell.<span class="property">c</span>) </span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">update</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">update_size</span>();</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable language_">this</span>.<span class="title function_">check_ready</span>()) &#123; <span class="comment">// 两条蛇都准备好进入下一回合了</span></span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">next_step</span>();  <span class="comment">// 让两条蛇进入下一回合</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">render</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="comment">// 画图 </span></span><br><span class="line">        <span class="keyword">const</span> color_even = <span class="string">&#x27;#AAD751&#x27;</span>, color_odd = <span class="string">&#x27;#A2D149&#x27;</span>  <span class="comment">// 定义两种颜色</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">let</span> r = <span class="number">0</span>; r &lt; <span class="variable language_">this</span>.<span class="property">rows</span>; r ++) &#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">let</span> c = <span class="number">0</span>; c &lt; <span class="variable language_">this</span>.<span class="property">cols</span>; c ++) &#123;</span><br><span class="line">                <span class="keyword">if</span>((r + c) % <span class="number">2</span> == <span class="number">0</span>) <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">fillStyle</span> = color_even;</span><br><span class="line">                <span class="keyword">else</span> <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">fillStyle</span> = color_odd;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="title function_">fillRect</span>(c * <span class="variable language_">this</span>.<span class="property">L</span>, r * <span class="variable language_">this</span>.<span class="property">L</span>, <span class="variable language_">this</span>.<span class="property">L</span>, <span class="variable language_">this</span>.<span class="property">L</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">destroy</span>(<span class="params"></span>) &#123;</span><br><span class="line">    </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="实现效果-2"><a href="#实现效果-2" class="headerlink" title="实现效果"></a>实现效果</h3><p>当匹配成功后，可以看到两个玩家的地图是完全一样的。</p>
<p><img src="/img/AcWing/SpringBoot/05Course/image-20230322193150264.png" alt="image-20230322193150264"></p>
<p><img src="/img/AcWing/SpringBoot/05Course/image-20230322193203690.png" alt="image-20230322193203690"></p>
<h2 id="实现玩家的位置同步"><a href="#实现玩家的位置同步" class="headerlink" title="实现玩家的位置同步"></a>实现玩家的位置同步</h2><blockquote>
<p>玩家1的视角：自己在左下角，对手在右上角</p>
<p>玩家2的视角：自己在右上角，对手在左下角</p>
</blockquote>
<p>因此需要将玩家的位置信息也放在后端实现<code>consumer/utils/Player.java</code>，并且在后端实现的地图类<code>consumer/utils/Game.java</code>里引入两个玩家的信息并进行同步。</p>
<h3 id="实现步骤-4"><a href="#实现步骤-4" class="headerlink" title="实现步骤"></a>实现步骤</h3><h4 id="后端实现"><a href="#后端实现" class="headerlink" title="后端实现"></a>后端实现</h4><ul>
<li>后端：实现玩家类<code>consumer/utils/Player.java</code>。里面包含玩家的id、起始位置（横纵坐标）以及玩家每一步所走的方向。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kob.backend.consumer.utils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> xzt</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Player</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line">    <span class="keyword">private</span> Integer sx;</span><br><span class="line">    <span class="keyword">private</span> Integer sy;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;Integer&gt; steps;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>后端：修改<code>consumer/utils/Game.java</code><ul>
<li>引入两个玩家类<code>playerA</code>，<code>playerB</code>。其中A是左下角，B是右上角位置</li>
<li>修改构造函数，对两个玩家对象进行初始化。</li>
<li>实现两个玩家的<code>get</code>函数。</li>
<li>修改<code>startMatching</code>函数，当两个玩家匹配成功后，许需要将两个玩家的信息（id、sx、sy）以及地图信息发送给前端。</li>
</ul>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Player playerA, playerB;  <span class="comment">// 记录两个蛇的位置，playerA是左下角，playerB是右上角</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">Game</span><span class="params">(Integer rows, Integer cols, Integer inner_walls_count, Integer idA, Integer idB)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.rows = rows;</span><br><span class="line">    <span class="built_in">this</span>.cols = cols;</span><br><span class="line">    <span class="built_in">this</span>.inner_walls_count = inner_walls_count;</span><br><span class="line">    <span class="built_in">this</span>.g = <span class="keyword">new</span> <span class="title class_">int</span>[rows][cols];</span><br><span class="line">    playerA = <span class="keyword">new</span> <span class="title class_">Player</span>(idA, <span class="built_in">this</span>.rows - <span class="number">2</span>, <span class="number">1</span>, <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;());</span><br><span class="line">    playerB = <span class="keyword">new</span> <span class="title class_">Player</span>(idB, <span class="number">1</span>, <span class="built_in">this</span>.cols - <span class="number">2</span>, <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> Player <span class="title function_">getPlayerA</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> playerA;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> Player <span class="title function_">getPlayerB</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> playerB;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">startMatching</span><span class="params">()</span> &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;start matching&quot;</span>);</span><br><span class="line">    matchpool.add(<span class="built_in">this</span>.user);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(matchpool.size() &gt;= <span class="number">2</span>) &#123;</span><br><span class="line">        Iterator&lt;User&gt; it = matchpool.iterator();</span><br><span class="line">        <span class="type">User</span> <span class="variable">a</span> <span class="operator">=</span> it.next(), b = it.next();</span><br><span class="line">        matchpool.remove(a);</span><br><span class="line">        matchpool.remove(b);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 生成地图</span></span><br><span class="line">        <span class="type">Game</span> <span class="variable">game</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Game</span>(<span class="number">13</span>, <span class="number">14</span>, <span class="number">20</span>, a.getId(), b.getId());</span><br><span class="line">        game.createMap();</span><br><span class="line">        </span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">respGame</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line">        respGame.put(<span class="string">&quot;a_id&quot;</span>, game.getPlayerA().getId());</span><br><span class="line">        respGame.put(<span class="string">&quot;a_sx&quot;</span>, game.getPlayerA().getSx());</span><br><span class="line">        respGame.put(<span class="string">&quot;a_sy&quot;</span>, game.getPlayerA().getSy());</span><br><span class="line">        respGame.put(<span class="string">&quot;b_id&quot;</span>, game.getPlayerB().getId());</span><br><span class="line">        respGame.put(<span class="string">&quot;b_sx&quot;</span>, game.getPlayerB().getSx());</span><br><span class="line">        respGame.put(<span class="string">&quot;b_sy&quot;</span>, game.getPlayerB().getSy());</span><br><span class="line">        respGame.put(<span class="string">&quot;map&quot;</span>, game.getG());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 往前端传递匹配成功的信息</span></span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">respA</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line">        respA.put(<span class="string">&quot;event&quot;</span>, <span class="string">&quot;success-matching&quot;</span>);</span><br><span class="line">        respA.put(<span class="string">&quot;opponent_username&quot;</span>, b.getUsername());</span><br><span class="line">        respA.put(<span class="string">&quot;opponent_photo&quot;</span>, b.getPhoto());</span><br><span class="line">        respA.put(<span class="string">&quot;game&quot;</span>, respGame);</span><br><span class="line">        <span class="comment">// 获取A的webSocket，并向前端发送信息</span></span><br><span class="line">        <span class="type">WebSocketServer</span> <span class="variable">webSocketServerA</span> <span class="operator">=</span> users.get(a.getId());</span><br><span class="line">        webSocketServerA.sendMessage(respA.toJSONString());</span><br><span class="line"></span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">respB</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line">        respB.put(<span class="string">&quot;event&quot;</span>, <span class="string">&quot;success-matching&quot;</span>);</span><br><span class="line">        respB.put(<span class="string">&quot;opponent_username&quot;</span>, a.getUsername());</span><br><span class="line">        respB.put(<span class="string">&quot;opponent_photo&quot;</span>, a.getPhoto());</span><br><span class="line">        respB.put(<span class="string">&quot;game&quot;</span>, respGame);</span><br><span class="line">        <span class="comment">//获取B的webSocket并向前端发送信息</span></span><br><span class="line">        users.get(b.getId()).sendMessage(respB.toJSONString());</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="前端实现-2"><a href="#前端实现-2" class="headerlink" title="前端实现"></a>前端实现</h4><ul>
<li>前端：修改<code>store/pk.js</code>，<ul>
<li>添加自己以及对手的信息（包括两个玩家的id，两个玩家的起始位置，以及地图信息），</li>
<li>添加更新函数，用来给上面的信息进行赋值<code>updateGame</code></li>
</ul>
</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">    <span class="attr">state</span>: &#123;</span><br><span class="line">        <span class="attr">status</span>: <span class="string">&quot;matching&quot;</span>, <span class="comment">// matching 表示正在匹配，playing表示正在对战。</span></span><br><span class="line">        <span class="attr">socket</span>: <span class="literal">null</span>,</span><br><span class="line">        <span class="attr">opponent_username</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">        <span class="attr">opponent_photo</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">        <span class="attr">gamemap</span>: <span class="literal">null</span>,</span><br><span class="line">        <span class="attr">a_id</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="attr">a_sx</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="attr">a_sy</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="attr">b_id</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="attr">b_sx</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="attr">b_sy</span>: <span class="number">0</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">getters</span>: &#123;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">mutations</span>: &#123;  <span class="comment">// 用来给state赋值，相当于set(), 但是是私有的，</span></span><br><span class="line">        <span class="title function_">updateSocket</span>(<span class="params">state, socket</span>) &#123;</span><br><span class="line">            state.<span class="property">socket</span> = socket;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="title function_">updateOpponent</span>(<span class="params">state, opponent</span>) &#123;</span><br><span class="line">            state.<span class="property">opponent_username</span> = opponent.<span class="property">username</span>;</span><br><span class="line">            state.<span class="property">opponent_photo</span> = opponent.<span class="property">photo</span>;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="title function_">updateStatus</span>(<span class="params">state, status</span>) &#123;</span><br><span class="line">            state.<span class="property">status</span> = status;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="title function_">updateGame</span>(<span class="params">state, game</span>) &#123;</span><br><span class="line">            state.<span class="property">gamemap</span> = game.<span class="property">map</span>;</span><br><span class="line">            state.<span class="property">a_id</span> = game.<span class="property">a_id</span>;</span><br><span class="line">            state.<span class="property">a_sx</span> = game.<span class="property">a_sx</span>;</span><br><span class="line">            state.<span class="property">a_sy</span> = game.<span class="property">a_sy</span>;</span><br><span class="line">            state.<span class="property">b_id</span> = game.<span class="property">b_id</span>;</span><br><span class="line">            state.<span class="property">b_sx</span> = game.<span class="property">b_sx</span>;</span><br><span class="line">            state.<span class="property">b_sy</span> = game.<span class="property">b_sy</span>;</span><br><span class="line">        &#125;, </span><br><span class="line">    &#125;, </span><br><span class="line">    <span class="attr">actions</span>: &#123;  <span class="comment">// 实现函数，公有函数，可以被外面调用，然后调用私有函数对变量进行赋值</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">modules</span>: &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>前端：修改<code>views/pk/PkIndexView.vue</code>中的<code>socket.onmessage</code>函数。当匹配成功后，通过调用updateGame来将后端传过来的所有信息保存在<code>store/pk.js</code>中。<code>store.commit(&quot;updateGame&quot;, data.game);</code></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">    socket.onmessage = msg =&gt; &#123;</span><br><span class="line">        const data = JSON.parse(msg.data);</span><br><span class="line">        if(data.event === &quot;success-matching&quot;) &#123;  // 表示匹配成功</span><br><span class="line">            store.commit(&quot;updateOpponent&quot;, &#123;</span><br><span class="line">                username: data.opponent_username,</span><br><span class="line">                photo: data.opponent_photo,</span><br><span class="line">            &#125;);</span><br><span class="line">            setTimeout(() =&gt; &#123;</span><br><span class="line">                store.commit(&quot;updateStatus&quot;, &quot;playing&quot;);</span><br><span class="line">            &#125;, 2000);</span><br><span class="line">            store.commit(&quot;updateGame&quot;, data.game);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<h3 id="实现效果-3"><a href="#实现效果-3" class="headerlink" title="实现效果"></a>实现效果</h3><p>如上面所说，虽然不能直观的看出，但是对于玩家1的视角：自己在左下角，对手在右上角；玩家2的视角：自己在右上角，对手在左下角</p>
<p><img src="/img/AcWing/SpringBoot/05Course/image-20230323105120740.png" alt="image-20230323105120740"></p>
<h2 id="实现蛇的移动（同步）⭐⭐"><a href="#实现蛇的移动（同步）⭐⭐" class="headerlink" title="实现蛇的移动（同步）⭐⭐"></a>实现蛇的移动（同步）⭐⭐</h2><p>因为每局游戏现在有三个棋盘，每个用户各一个棋盘，再加上云端维护一个棋盘。因此需要保证三个棋盘的状态同步。</p>
<p>因为如果出现了多局游戏对战，可能会发生冲突，因此需要将Game类改为支持多线程，每产生一局游戏都会开一个线程。</p>
<p><img src="/img/AcWing/SpringBoot/05Course/image-20230322200513253.png" alt="image-20230322200513253"></p>
<h3 id="实现步骤-5"><a href="#实现步骤-5" class="headerlink" title="实现步骤"></a>实现步骤</h3><h4 id="后端实现-1"><a href="#后端实现-1" class="headerlink" title="后端实现"></a>后端实现</h4><ul>
<li>将后端的<code>consumer/utils/Game</code>变为支持多线程的类<ul>
<li>继承<code>Thread</code>类</li>
<li>重写<code>Thread</code>类的入口函数<code>run()</code>方法</li>
</ul>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Game</span> <span class="keyword">extends</span> <span class="title class_">Thread</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 新线程的入口函数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 执行每回合的操作</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>在<code>consumer/WebSocketServer</code>的<code>startMatching</code>函数中启动一个线程。<strong>当匹配成功后启动一个线程</strong>。<ul>
<li>需要保存<code>game</code>对象:<code>private Game game = null;</code></li>
<li>修改<code>startMatching</code>函数，匹配成功后启动一个线程。启动线程后需要将game对象分别保存在两名玩家自己的game对象中。<code>users.get(a.getId()).game = game; users.get(b.getId()).game = game;</code></li>
</ul>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">Game</span> <span class="variable">game</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">startMatching</span><span class="params">()</span> &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;start matching&quot;</span>);</span><br><span class="line">    matchpool.add(<span class="built_in">this</span>.user);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(matchpool.size() &gt;= <span class="number">2</span>) &#123;</span><br><span class="line">        Iterator&lt;User&gt; it = matchpool.iterator();</span><br><span class="line">        <span class="type">User</span> <span class="variable">a</span> <span class="operator">=</span> it.next(), b = it.next();</span><br><span class="line">        matchpool.remove(a);</span><br><span class="line">        matchpool.remove(b);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 生成地图</span></span><br><span class="line">        <span class="type">Game</span> <span class="variable">game</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Game</span>(<span class="number">13</span>, <span class="number">14</span>, <span class="number">20</span>, a.getId(), b.getId());</span><br><span class="line">        game.createMap();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 启动一个线程，</span></span><br><span class="line">        game.start();</span><br><span class="line">        users.get(a.getId()).game = game;</span><br><span class="line">        users.get(b.getId()).game = game;</span><br><span class="line"></span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">respGame</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line">        respGame.put(<span class="string">&quot;a_id&quot;</span>, game.getPlayerA().getId());</span><br><span class="line">        respGame.put(<span class="string">&quot;a_sx&quot;</span>, game.getPlayerA().getSx());</span><br><span class="line">        respGame.put(<span class="string">&quot;a_sy&quot;</span>, game.getPlayerA().getSy());</span><br><span class="line">        respGame.put(<span class="string">&quot;b_id&quot;</span>, game.getPlayerB().getId());</span><br><span class="line">        respGame.put(<span class="string">&quot;b_sx&quot;</span>, game.getPlayerB().getSx());</span><br><span class="line">        respGame.put(<span class="string">&quot;b_sy&quot;</span>, game.getPlayerB().getSy());</span><br><span class="line">        respGame.put(<span class="string">&quot;map&quot;</span>, game.getG());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 往前端传递匹配成功的信息</span></span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">respA</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line">        respA.put(<span class="string">&quot;event&quot;</span>, <span class="string">&quot;success-matching&quot;</span>);</span><br><span class="line">        respA.put(<span class="string">&quot;opponent_username&quot;</span>, b.getUsername());</span><br><span class="line">        respA.put(<span class="string">&quot;opponent_photo&quot;</span>, b.getPhoto());</span><br><span class="line">        respA.put(<span class="string">&quot;game&quot;</span>, respGame);</span><br><span class="line">        <span class="comment">// 获取A的webSocket，并向前端发送信息</span></span><br><span class="line">        <span class="type">WebSocketServer</span> <span class="variable">webSocketServerA</span> <span class="operator">=</span> users.get(a.getId());</span><br><span class="line">        webSocketServerA.sendMessage(respA.toJSONString());</span><br><span class="line"></span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">respB</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line">        respB.put(<span class="string">&quot;event&quot;</span>, <span class="string">&quot;success-matching&quot;</span>);</span><br><span class="line">        respB.put(<span class="string">&quot;opponent_username&quot;</span>, a.getUsername());</span><br><span class="line">        respB.put(<span class="string">&quot;opponent_photo&quot;</span>, a.getPhoto());</span><br><span class="line">        respB.put(<span class="string">&quot;game&quot;</span>, respGame);</span><br><span class="line">        <span class="comment">//获取B的webSocket并向前端发送信息</span></span><br><span class="line">        users.get(b.getId()).sendMessage(respB.toJSONString());</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>在<code>consumer/utils/Game.java</code>中实现具体的操作逻辑⭐<ul>
<li>为了记录两名玩家的下一步操作，需要引入两个成员变量<code>nextStepA</code>和<code>nextStepB</code>，初始都为<code>null</code></li>
<li>引入一个成员变量<code>status</code>，用来记录游戏的状态，<code>playing</code>表示正在进行游戏，<code>finished</code>表示游戏结束了。</li>
<li>引入一个成员变量<code>loser</code>，记录游戏的输家。<code>all</code>表示为平局，A表示A输，B表示B输。</li>
<li>因为<code>nextStepA</code>和<code>nextStepB</code>可能两个线程同时读写，涉及到<strong>读写冲突</strong>，因此需要实现一个锁给每一个操作加锁。<code>private ReentrantLock lock = new ReentrantLock();</code></li>
<li>实现两个<code>set</code>函数，来给两个变量<code>nextStepA</code>和<code>nextStepB</code>赋值。因为可能会产生读写冲突，因此需要加锁。</li>
<li>实现<code>nextStep()</code>函数，等待两名玩家进行操作，如果5s内两名玩家都已经操作了，则返回<code>true</code>，否则返回<code>false</code>，则游戏就该结束了。<ul>
<li><strong>注意</strong>：这边有个小细节，循环50次，每次睡100ms，如果时循环5次，每次睡1000ms，则可能按下键后他会把1s睡完才执行，会卡顿一下。</li>
</ul>
</li>
<li>实现<code>run()</code>函数，每一步操作先调用<code>nextStep</code>函数，来判断两个玩家是否都有输入了。<ul>
<li>如果没有获取下一步操作，修改游戏状态为<code>finished</code>，然后判断一些游戏的输家并记录在<code>loser</code>中，然后将结果发送给前端，通过调用<code>sendResult</code>函数</li>
<li>如果获取到下一步操作，首先通过调用<code>judge</code>函数来判断两条蛇的操作是否合法：<ul>
<li>如果<code>judge</code>结束之后，游戏状态仍为<code>playing</code>，则向前端发送移动的信息，调用<code>sendMove()</code>函数</li>
<li>否则，通过调用<code>sendResult</code>函数向前端发送结果信息。结束游戏。</li>
</ul>
</li>
</ul>
</li>
<li>实现<code>sendResult</code>函数：需要使用<code>JSONObject</code>向前端传送信息，包括（游戏结束的提示<code>event: result</code>，以及输家<code>loser</code>）,然后调用<code>sendAllMessage</code>函数向两个玩家都发送信息。</li>
<li>实现<code>sendMove</code>函数：需要使用<code>JSONObject</code>向前端传送信息，包括（移动的提示<code>event: move</code>，以及两个玩家的移动方向<code>a_direction: nextStepA</code>和<code>b_direction: nextStepB</code>，然后调用<code>sendAllMessage</code>函数向两个玩家都发送信息，发送玩信息后需要将<code>nextStepA</code>和<code>nextStepB</code>清空。</li>
<li>实现<code>sendAllMessage</code>函数：在这个函数中需要调用<code>WebSocketServer</code>类中的<code>users</code>，来找到两个玩家的websocket，在发送消息。<ul>
<li>修改<code>WebSocketServer</code>的<code>users</code>为<code>public</code>，因为是静态的，所以可以直接通过<code>类名.users</code>使用。</li>
<li>根据玩家的<code>id</code>来找到对应的<code>websocket</code>，并调用<code>onMessage</code>来向前端发送消息。<code>WebSocketServer.users.get(playerA.getId()).sendMessage(message);</code></li>
</ul>
</li>
<li>实现<code>judge</code>函数：实现起来比较复杂，在这段代码后详细说明。</li>
</ul>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">Integer</span> <span class="variable">nextStepA</span> <span class="operator">=</span> <span class="literal">null</span>;  <span class="comment">// 记录两个玩家的下一步操作</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">Integer</span> <span class="variable">nextStepB</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="type">String</span> <span class="variable">status</span> <span class="operator">=</span> <span class="string">&quot;playing&quot;</span>;  <span class="comment">// 游戏状态， playing ---&gt; finished</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">String</span> <span class="variable">loser</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;  <span class="comment">// all 平局，A：A输，B：B输</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="type">ReentrantLock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>();  <span class="comment">// 定义一个锁，用来保证nextStepA和nextStepB的读写一致性，因为会涉及到两个线程的读写操作</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setNextStepA</span><span class="params">(Integer nextStepA)</span> &#123;</span><br><span class="line">    lock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.nextStepA = nextStepA;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setNextStepB</span><span class="params">(Integer nextStepB)</span> &#123;</span><br><span class="line">    lock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.nextStepB = nextStepB;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 等待两个玩家的下一步操作</span></span><br><span class="line"><span class="comment">* <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">nextStep</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;  <span class="comment">// 在接收下一步时先睡200ms，防止在前端渲染的过程中玩家的输入进行遗漏</span></span><br><span class="line">        Thread.sleep(<span class="number">200</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 这边有个小细节，循环50次，每次睡100ms，如果时循环5次，每次睡1000ms，则可能按下键后他会把1s睡完才执行，会卡顿一下。</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">50</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">100</span>);  <span class="comment">// 先睡100ms秒，短暂的释放锁，给玩家输入的时间</span></span><br><span class="line">            lock.lock();  <span class="comment">// 1s过后，拿住锁，然后在判断两名玩家是否已经输入</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span>(nextStepA != <span class="literal">null</span> &amp;&amp; nextStepB != <span class="literal">null</span>) &#123;</span><br><span class="line">                    playerA.getSteps().add(nextStepA);</span><br><span class="line">                    playerB.getSteps().add(nextStepB);</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                lock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 判断两名玩家下一步操作是否合法</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">judge</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 向所有玩家发送信息</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">sendAllMessage</span><span class="params">(String message)</span> &#123;</span><br><span class="line">    WebSocketServer.users.get(playerA.getId()).sendMessage(message); <span class="comment">// 这里的sendMessage是WebSocketServer里的</span></span><br><span class="line">    WebSocketServer.users.get(playerB.getId()).sendMessage(message);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 像两个client传送移动信息，这里是两名玩家的移动信息</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">sendMove</span><span class="params">()</span> &#123;</span><br><span class="line">    lock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">resp</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line">        resp.put(<span class="string">&quot;event&quot;</span>, <span class="string">&quot;move&quot;</span>);</span><br><span class="line">        resp.put(<span class="string">&quot;a_direction&quot;</span>, nextStepA);</span><br><span class="line">        resp.put(<span class="string">&quot;b_direction&quot;</span>, nextStepB);</span><br><span class="line">        sendAllMessage(resp.toJSONString());  <span class="comment">// 将移动信息返回给前端</span></span><br><span class="line">        nextStepA = nextStepB = <span class="literal">null</span>;  <span class="comment">// 将两个玩家的下一步清空</span></span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 像两个client公布结果, 这里是游戏结果，</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">sendResult</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">JSONObject</span> <span class="variable">resp</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line">    resp.put(<span class="string">&quot;event&quot;</span>, <span class="string">&quot;result&quot;</span>);</span><br><span class="line">    resp.put(<span class="string">&quot;loser&quot;</span>, loser);</span><br><span class="line">    sendAllMessage(resp.toJSONString());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 新线程的入口函数</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (nextStep()) &#123;  <span class="comment">// 是否获取两条蛇的下一步操作</span></span><br><span class="line">            judge();</span><br><span class="line">            <span class="keyword">if</span> (<span class="string">&quot;playing&quot;</span>.equals(status)) &#123;  <span class="comment">// 两名玩家的下一步操作合法</span></span><br><span class="line">                sendMove();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                sendResult();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            status = <span class="string">&quot;finished&quot;</span>;</span><br><span class="line">            lock.lock();  <span class="comment">// 涉及nextStepA和nextStepB的读取操作，需要加锁</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (nextStepA == <span class="literal">null</span> &amp;&amp; nextStepB == <span class="literal">null</span>)</span><br><span class="line">                    loser = <span class="string">&quot;all&quot;</span>;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (nextStepA == <span class="literal">null</span>)</span><br><span class="line">                    loser = <span class="string">&quot;A&quot;</span>;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    loser = <span class="string">&quot;B&quot;</span>;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                lock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">            sendResult();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><p>实现<code>judge</code>函数：用来判断两条蛇的下一不操作是否合法。因此需要获取到两条蛇的身体。</p>
<ul>
<li><p>实现一个<code>consumer/utils/Cell</code>类，用来保存蛇身的某个节点的信息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kob.backend.consumer.utils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> xzt</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * 蛇身体的某个节点</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Cell</span> &#123;</span><br><span class="line">    Integer x;</span><br><span class="line">    Integer y;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>在<code>consumer/utils/Play.java</code>中实现获取蛇的全部节点函数<code>getCells()</code></p>
<ul>
<li>实现<code>getCells()</code>函数，通过遍历每一步蛇的移动方向，来将新的节点加入<code>res</code>中，新的节点就是蛇头，同时我们需要判断当前回合是否会增加长度，如果不增加，则需要删掉蛇尾（也就是下标为0的节点）。判断完之后，需要更新<code>loser</code>来获得游戏的输家。</li>
<li>实现<code>check_tail_increasing(step)</code>函数：如果是前十回合，则蛇会增加长度，否则每三回合增加一次。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 检查当前回合，蛇的身体是否会增长.</span></span><br><span class="line"><span class="comment"> * 前十回合会增长，后面每三回合增长一次。</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> steps</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">check_tail_increasing</span><span class="params">(<span class="type">int</span> step)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span>(step &lt;= <span class="number">10</span>) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">return</span> step % <span class="number">3</span> == <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 返回蛇的身体，由若干个Cell组成</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 当前对象的所有节点信息</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> List&lt;Cell&gt; <span class="title function_">getCells</span><span class="params">()</span> &#123;</span><br><span class="line">    List&lt;Cell&gt; res = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="type">int</span>[] dx = &#123;-<span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>&#125;, dy = &#123;<span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, -<span class="number">1</span>&#125;;</span><br><span class="line">    <span class="type">int</span> <span class="variable">x</span> <span class="operator">=</span> sx, y = sy;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> <span class="variable">step</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    res.add(<span class="keyword">new</span> <span class="title class_">Cell</span>(x, y));</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> d : steps) &#123;  <span class="comment">// 遍历每一回合蛇的移动方向</span></span><br><span class="line">        x += dx[d];</span><br><span class="line">        y += dy[d];</span><br><span class="line">        res.add(<span class="keyword">new</span> <span class="title class_">Cell</span>(x, y));</span><br><span class="line">        <span class="keyword">if</span> (!check_tail_increasing(++ step)) &#123; <span class="comment">// 如果蛇尾不增加,</span></span><br><span class="line">            res.remove(<span class="number">0</span>); <span class="comment">// 需要将蛇尾删掉</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>实现<code>judge</code>函数,判断两个蛇的下一步操作是否合法。需要实现一个辅助函数<code>check_valid(cellsA, cellsB)</code>，来判断<code>cellsA</code>的头节点是否是墙或者碰撞到<code>cellsA</code>或者<code>cellsB</code>的身体。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 判断蛇A的头节点是否合法</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> cellsA</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> cellsB</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">check_valid</span><span class="params">(List&lt;Cell&gt; cellsA, List&lt;Cell&gt; cellsB)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> cellsA.size();</span><br><span class="line">    <span class="type">Cell</span> <span class="variable">cell</span> <span class="operator">=</span> cellsA.get(n - <span class="number">1</span>);  <span class="comment">// 新的蛇头</span></span><br><span class="line">    <span class="keyword">if</span>(g[cell.x][cell.y] == <span class="number">1</span>) <span class="keyword">return</span> <span class="literal">false</span>; <span class="comment">// 如果蛇的最后一步是障碍物</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; n - <span class="number">1</span>; i++) &#123;  <span class="comment">// 判断和蛇A有没有碰撞</span></span><br><span class="line">        <span class="keyword">if</span>(cellsA.get(i).x == cell.x &amp;&amp; cellsA.get(i).y == cell.y)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; n - <span class="number">1</span>; i++) &#123;  <span class="comment">// 判断和蛇B有没有碰撞</span></span><br><span class="line">        <span class="keyword">if</span>(cellsB.get(i).x == cell.x &amp;&amp; cellsB.get(i).y == cell.y)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 判断两名玩家下一步操作是否合法</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">judge</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 取出两条蛇的所有节点</span></span><br><span class="line">    List&lt;Cell&gt; cellsA = playerA.getCells();</span><br><span class="line">    List&lt;Cell&gt; cellsB = playerB.getCells();</span><br><span class="line"></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">validA</span> <span class="operator">=</span> check_valid(cellsA, cellsB);</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">validB</span> <span class="operator">=</span> check_valid(cellsB, cellsA);</span><br><span class="line">    <span class="comment">// 如果两个玩家的操作存在不合法。</span></span><br><span class="line">    <span class="keyword">if</span>(!validA || !validB) &#123;</span><br><span class="line">        status = <span class="string">&quot;finished&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span>(!validA &amp;&amp; !validB) loser = <span class="string">&quot;all&quot;</span>;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(!validA) loser = <span class="string">&quot;A&quot;</span>;</span><br><span class="line">        <span class="keyword">else</span> loser = <span class="string">&quot;B&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<h4 id="前端实现-3"><a href="#前端实现-3" class="headerlink" title="前端实现"></a>前端实现</h4><ul>
<li><p>修改<code>views/pk/PkIndexView.vue</code>中的<code>socket.message</code>函数，来对接收到的后端消息进行处理。</p>
<ul>
<li><p>之前已经写过当接收到的<code>event</code>是<code>success-matching</code>时的逻辑代码。</p>
</li>
<li><p>当接收到的<code>event</code>是<code>move</code>时，表示两个玩家都有了合法的输入，<strong>需要在前端渲染移动</strong>。</p>
<ul>
<li><p>为了能够取到两条蛇，所以需要将前端的<code>GameMap</code>对象保存下来。</p>
<ul>
<li><p>在<code>store/pk.js</code>中添加<code>gameObject: null,</code>并且实现<code>updateGameObject</code>函数。</p>
</li>
<li><p>在<code>components/GameMap.vue</code>中的加载函数中生成GameMap对象并调用<code>updateGameObject</code>保存。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">    onMounted(() =&gt; &#123;</span><br><span class="line">        store.commit(</span><br><span class="line">            &quot;updateGameObject&quot;,</span><br><span class="line">            new GameMap(canvas.value.getContext(&#x27;2d&#x27;), parent.value, store)  //创建一个GameMap对象</span><br><span class="line">        );</span><br><span class="line">    &#125;);</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>通过<code>gameObject</code>来获取两条蛇的对象，分别调用<code>set_direction()</code>函数来设置对应的移动方向。</p>
</li>
</ul>
</li>
<li><p>当接收到的<code>event</code>时<code>result</code>时，表示游戏已经产生结果了，<strong>需要渲染失败的玩家</strong>。</p>
<ul>
<li>同样也需要通过<code>gameObject</code>来获取两条蛇的对象，然后判断后端传过来的<code>data.loser</code>，来将对应的蛇的状态设置为<code>die</code>即可。</li>
<li>同时，需要将前端的判断删除，删除<code>scripts/Snake.js</code>中的<code>next_step()</code>函数中的最后的<code>if</code>语句</li>
</ul>
</li>
</ul>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">    socket.onmessage = msg =&gt; &#123;</span><br><span class="line">        const data = JSON.parse(msg.data);</span><br><span class="line">        if(data.event === &quot;success-matching&quot;) &#123;  // 表示匹配成功</span><br><span class="line">            store.commit(&quot;updateOpponent&quot;, &#123;</span><br><span class="line">                username: data.opponent_username,</span><br><span class="line">                photo: data.opponent_photo,</span><br><span class="line">            &#125;);</span><br><span class="line">            setTimeout(() =&gt; &#123;</span><br><span class="line">                store.commit(&quot;updateStatus&quot;, &quot;playing&quot;);</span><br><span class="line">            &#125;, 2000);</span><br><span class="line">            store.commit(&quot;updateGame&quot;, data.game);</span><br><span class="line">        &#125; else if (data.event === &quot;move&quot;) &#123;  // 接收到后端的消息为 需要移动</span><br><span class="line">            const game = store.state.pk.gameObject;</span><br><span class="line">            const [snake0, snake1] = game.snakes; // 取出两条蛇</span><br><span class="line">            snake0.set_direction(data.a_direction);</span><br><span class="line">            snake1.set_direction(data.b_direction);</span><br><span class="line">        &#125; else if (data.event === &quot;result&quot;) &#123;  // 游戏已经产生结果了</span><br><span class="line">            const game = store.state.pk.gameObject;</span><br><span class="line">            const [snake0, snake1] = game.snakes; // 取出两条蛇</span><br><span class="line">            if (data.loser === &quot;all&quot; || data.loser === &quot;A&quot;) &#123;</span><br><span class="line">                snake0.status = &quot;die&quot;;</span><br><span class="line">            &#125;</span><br><span class="line">            if (data.loser === &quot;all&quot; || data.loser === &quot;B&quot;) &#123;</span><br><span class="line">                snake1.status = &quot;die&quot;;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<h3 id="实现效果-4"><a href="#实现效果-4" class="headerlink" title="实现效果"></a>实现效果</h3><p>两条蛇可以交互移动，如果某一条蛇超过5s没操作或者装障碍物或者撞到两个蛇的身体，则这条蛇输。</p>
<p><img src="/img/AcWing/SpringBoot/05Course/image-20230323155220988.png" alt="image-20230323155220988"></p>
<h2 id="游戏结果优化"><a href="#游戏结果优化" class="headerlink" title="游戏结果优化"></a>游戏结果优化</h2><p>当游戏结束后，需要提示对应玩家的输赢信息。例如玩家A赢了，在玩家A的界面就现实Win，在玩家B的界面就显示Lose</p>
<h3 id="实现步骤-6"><a href="#实现步骤-6" class="headerlink" title="实现步骤"></a>实现步骤</h3><p>这里是纯前端就可以实现，因为所需要的信息前面实现的后端已经满足了。</p>
<ul>
<li>在<code>store/pk.js</code>中添加变量<code>loser</code>用来保存输的玩家，同时实现<code>updateLoser</code>函数</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">    <span class="attr">state</span>: &#123;</span><br><span class="line">        <span class="attr">loser</span>: <span class="string">&quot;none&quot;</span>,  <span class="comment">// none / all / A / B</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">mutations</span>: &#123;</span><br><span class="line">        <span class="title function_">updateLoser</span>(<span class="params">state, loser</span>) &#123;</span><br><span class="line">            state.<span class="property">loser</span> = loser;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><p>修改<code>views/pk/PkIndexView.vue</code>，当游戏产生结果后，调用<code>updateLoser</code>对<code>loser</code>进行更新</p>
</li>
<li><p>实现<code>components/ResultBoard.vue</code></p>
<ul>
<li>现实 <strong>Draw/Win/Lose</strong> 需要根据<code>$store.state.pk.loser</code>的内容以及当前用户的id来进行判断。</li>
<li>实现触发函数<code>restart()</code>当点击再来时，需要更新一些全局变量，将整个游戏的状态改为<code>matching</code>，则会自动跳转至匹配界面，将<code>loser</code>重新设置为none，将对手的头像和名字设为默认值。</li>
</ul>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">    &lt;div class=&quot;result-board&quot;&gt;</span><br><span class="line">        &lt;div class=&quot;result-board-text&quot; v-if=&quot;$store.state.pk.loser === &#x27;all&#x27;&quot;&gt; </span><br><span class="line">            Draw</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">        &lt;div class=&quot;result-board-text&quot; v-else-if=&quot;$store.state.pk.loser === &#x27;A&#x27; &amp;&amp; $store.state.pk.a_id === parseInt($store.state.user.id)&quot;&gt; </span><br><span class="line">            Lose</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">        &lt;div class=&quot;result-board-text&quot; v-else-if=&quot;$store.state.pk.loser === &#x27;B&#x27; &amp;&amp; $store.state.pk.b_id === parseInt($store.state.user.id)&quot;&gt; </span><br><span class="line">            Lose</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">        &lt;div class=&quot;result-board-text&quot; v-else&gt; </span><br><span class="line">            Win</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">        &lt;div class=&quot;result-board-button&quot;&gt;</span><br><span class="line">            &lt;button @click=&quot;restart&quot; type=&quot;button&quot; class=&quot;btn btn-warning btn-lg&quot;&gt;</span><br><span class="line">                再来!</span><br><span class="line">            &lt;/button&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">import &#123; useStore &#125; from &#x27;vuex&#x27;;</span><br><span class="line"></span><br><span class="line">export default &#123;</span><br><span class="line">    setup() &#123;</span><br><span class="line">        const store = useStore();</span><br><span class="line">        const restart = () =&gt; &#123;</span><br><span class="line">            store.commit(&quot;updateStatus&quot;, &quot;matching&quot;);  // 进入匹配界面</span><br><span class="line">            store.commit(&quot;updateLoser&quot;, &quot;none&quot;);</span><br><span class="line">            store.commit(&quot;updateOpponent&quot;, &#123;</span><br><span class="line">                username: &quot;我的对手&quot;,</span><br><span class="line">                photo: &quot;https://cdn.acwing.com/media/article/image/2022/08/09/1_1db2488f17-anonymous.png&quot;,</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        return &#123;</span><br><span class="line">            restart,</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style scoped&gt;</span><br><span class="line">    div.result-board&#123;</span><br><span class="line">        height: 30vh;</span><br><span class="line">        width: 30vw;</span><br><span class="line">        background-color: rgba(50, 50, 50, 0.5);</span><br><span class="line">        position: absolute;</span><br><span class="line">        top: 30vh;</span><br><span class="line">        left: 35vw;</span><br><span class="line">    &#125;</span><br><span class="line">    div.result-board-text &#123;</span><br><span class="line">        text-align: center;</span><br><span class="line">        color: white;</span><br><span class="line">        font-size: 50px;</span><br><span class="line">        font-weight: 600;</span><br><span class="line">        font-style: italic;</span><br><span class="line">        padding-top: 5vh;</span><br><span class="line">    &#125;</span><br><span class="line">    div.result-board-button &#123;</span><br><span class="line">        text-align: center;</span><br><span class="line">        padding-top: 7vh;</span><br><span class="line">    &#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>
<ul>
<li>修改<code>views/pk/PkIndexView.vue</code>，导入<code>ResultBoard</code>组件，当<code>$store.state.pk.loser != &#39;none&#39;</code>显示该组件</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">&lt;PlayGround v-if=&quot;$store.state.pk.status === &#x27;playing&#x27;&quot;&gt;&lt;/PlayGround&gt;</span><br><span class="line">&lt;MatchGround v-if=&quot;$store.state.pk.status === &#x27;matching&#x27;&quot;&gt;&lt;/MatchGround&gt;</span><br><span class="line">&lt;ResultBoard v-if=&quot;$store.state.pk.loser != &#x27;none&#x27;&quot;&gt;&lt;/ResultBoard&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">    import ResultBoard from &#x27;@/components/ResultBoard.vue&#x27;</span><br><span class="line">    export default &#123;</span><br><span class="line">        components: &#123;</span><br><span class="line">            ResultBoard,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<h3 id="实现效果-5"><a href="#实现效果-5" class="headerlink" title="实现效果"></a>实现效果</h3><p><img src="/img/AcWing/SpringBoot/05Course/image-20230323165124198.png" alt="image-20230323165124198"></p>
<p>点击在来按钮时，跳转回匹配界面</p>
<p><img src="/img/AcWing/SpringBoot/05Course/image-20230323165136618.png" alt="image-20230323165136618"></p>
<h2 id="游戏对战记录保存"><a href="#游戏对战记录保存" class="headerlink" title="游戏对战记录保存"></a>游戏对战记录保存</h2><h3 id="数据库配置"><a href="#数据库配置" class="headerlink" title="数据库配置"></a>数据库配置</h3><p><code>record</code>表用来记录每局对战的信息</p>
<p>表中的列：</p>
<ul>
<li><code>id</code>: <code>int</code></li>
<li><code>a_id</code>: <code>int</code></li>
<li><code>a_sx</code>: <code>int</code></li>
<li><code>a_sy</code>: <code>int</code></li>
<li><code>b_id</code>: <code>int</code></li>
<li><code>b_sx</code>: <code>int</code></li>
<li><code>b_sy</code>: <code>int</code></li>
<li><code>a_steps</code>: <code>varchar(1000)</code></li>
<li><code>b_steps</code>: <code>varchar(1000)</code></li>
<li><code>map</code>: <code>varchar(1000)</code></li>
<li><code>loser</code>: <code>varchar(10)</code></li>
<li><code>createtime</code>: <code>datetime</code></li>
</ul>
<p><img src="/img/AcWing/SpringBoot/05Course/image-20230323165412377.png" alt="image-20230323165412377"></p>
<h3 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h3><ul>
<li>实现Record对应的实体类<code>pojo/Record</code></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kob.backend.pojo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.annotation.IdType;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.annotation.TableId;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.annotation.JsonFormat;</span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> xzt</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Record</span> &#123;</span><br><span class="line">    <span class="meta">@TableId(type = IdType.AUTO)</span></span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line">    <span class="keyword">private</span> Integer aId;</span><br><span class="line">    <span class="keyword">private</span> Integer aSx;</span><br><span class="line">    <span class="keyword">private</span> Integer aSy;</span><br><span class="line">    <span class="keyword">private</span> Integer bId;</span><br><span class="line">    <span class="keyword">private</span> Integer bSx;</span><br><span class="line">    <span class="keyword">private</span> Integer bSy;</span><br><span class="line">    <span class="keyword">private</span> String aSteps;</span><br><span class="line">    <span class="keyword">private</span> String bSteps;</span><br><span class="line">    <span class="keyword">private</span> String map;</span><br><span class="line">    <span class="keyword">private</span> String loser;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@JsonFormat(pattern = &quot;yyyy-MM-dd HH:mm:ss&quot;, timezone = &quot;Asia/Shanghai&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Date createTime;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>实现<code>mapper/RecordMapper</code></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kob.backend.mapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.core.mapper.BaseMapper;</span><br><span class="line"><span class="keyword">import</span> com.kob.backend.pojo.Record;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Mapper;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> xzt</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">RecordMapper</span> <span class="keyword">extends</span> <span class="title class_">BaseMapper</span>&lt;Record&gt; &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>在<code>consumer/WebSocketServer</code>中实现<code>RecordMapper</code>，并编写对应的set函数。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> RecordMapper recordMapper;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setRecordMapper</span><span class="params">(RecordMapper recordMapper)</span> &#123;</span><br><span class="line">    WebSocketServer.recordMapper = recordMapper;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><p>在<code>consumer/utils/Game</code>中编写<code>saveToDatabase</code>函数，实现将对战结果保存到数据库中，需要在<code>sendResult</code>中调用该函数。</p>
<ul>
<li><p>因为<code>consumer/utils/Play</code>中的steps是<code>List</code>类型，因此需要编写一个函数将steps转为<code>String</code>类型。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 将steps转为String保存</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">getStepsString</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">StringBuilder</span> <span class="variable">res</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> d: steps) &#123;</span><br><span class="line">        res.append(d);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> res.toString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>在<code>consumer/utils/Game</code>中编写函数<code>getMapString</code>函数将map转为<code>String</code>类型。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 将map转为String类型</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> String <span class="title function_">getMapString</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">StringBuilder</span> <span class="variable">res</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; rows; i++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; cols; j++) &#123;</span><br><span class="line">            res.append(g[i][j]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> res.toString();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 将对战记录保存到数据库中。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">saveToDatabase</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">Record</span> <span class="variable">record</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Record</span>(</span><br><span class="line">        <span class="literal">null</span>,</span><br><span class="line">        playerA.getId(),</span><br><span class="line">        playerA.getSx(),</span><br><span class="line">        playerA.getSy(),</span><br><span class="line">        playerB.getId(),</span><br><span class="line">        playerB.getSx(),</span><br><span class="line">        playerB.getSy(),</span><br><span class="line">        playerA.getStepsString(),</span><br><span class="line">        playerB.getStepsString(),</span><br><span class="line">        getMapString(),</span><br><span class="line">        loser,</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Date</span>()</span><br><span class="line">    );</span><br><span class="line">    <span class="comment">// 保存在数据库</span></span><br><span class="line">    WebSocketServer.recordMapper.insert(record);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 像两个client公布结果, 这里是游戏结果，</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">sendResult</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">JSONObject</span> <span class="variable">resp</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line">    resp.put(<span class="string">&quot;event&quot;</span>, <span class="string">&quot;result&quot;</span>);</span><br><span class="line">    resp.put(<span class="string">&quot;loser&quot;</span>, loser);</span><br><span class="line">    saveToDatabase();</span><br><span class="line">    sendAllMessage(resp.toJSONString());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<h3 id="实现效果-6"><a href="#实现效果-6" class="headerlink" title="实现效果"></a>实现效果</h3><p>当对局结束后，会将对局结果和对局记录保存到数据库中。</p>
<p><img src="/img/AcWing/SpringBoot/05Course/image-20230327144635988.png" alt="image-20230327144635988"></p>
<p>数据库数据</p>
<p><img src="/img/AcWing/SpringBoot/05Course/image-20230327144713998.png" alt="image-20230327144713998"></p>
<h1 id="实现匹配系统的微服务⭐"><a href="#实现匹配系统的微服务⭐" class="headerlink" title="实现匹配系统的微服务⭐"></a>实现匹配系统的微服务⭐</h1><h2 id="项目框架"><a href="#项目框架" class="headerlink" title="项目框架"></a>项目框架</h2><p><img src="/img/AcWing/SpringBoot/05Course/image-20230327150430601.png" alt="image-20230327150430601"></p>
<h2 id="微服务项目创建-amp-配置"><a href="#微服务项目创建-amp-配置" class="headerlink" title="微服务项目创建&amp;配置"></a>微服务项目创建&amp;配置</h2><h3 id="创建spring-cloud项目"><a href="#创建spring-cloud项目" class="headerlink" title="创建spring cloud项目"></a>创建spring cloud项目</h3><ul>
<li>创建项目</li>
</ul>
<p><img src="/img/AcWing/SpringBoot/05Course/image-20230327150622450.png" alt="image-20230327150622450"></p>
<ul>
<li>添加<code>spring web</code>依赖</li>
</ul>
<p><img src="/img/AcWing/SpringBoot/05Course/image-20230327150708383.png" alt="image-20230327150708383"></p>
<h3 id="配置Spring-Cloud项目"><a href="#配置Spring-Cloud项目" class="headerlink" title="配置Spring Cloud项目"></a>配置Spring Cloud项目</h3><ul>
<li>因为spring cloud是一个父级项目，所以将<code>src</code>目录删除</li>
<li>在<code>pom.xml</code>中添加依赖<ul>
<li>添加<code>&lt;packaging&gt;pom&lt;/packaging&gt;</code></li>
<li>添加<code>spring-cloud-dependencies</code>依赖</li>
</ul>
</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.7.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span> <span class="comment">&lt;!-- lookup parent from repository --&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.kob<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>backendcloud<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">packaging</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>backendcloud<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>backendcloud<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.springframework.cloud/spring-cloud-dependencies --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2021.0.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="创建子项目"><a href="#创建子项目" class="headerlink" title="创建子项目"></a>创建子项目</h3><p><img src="/img/AcWing/SpringBoot/05Course/image-20230327151644680.png" alt="image-20230327151644680"></p>
<h4 id="创建子项目matchingSystem"><a href="#创建子项目matchingSystem" class="headerlink" title="创建子项目matchingSystem"></a>创建子项目matchingSystem</h4><p>创建项目matchingsystem</p>
<p><img src="/img/AcWing/SpringBoot/05Course/image-20230327151727702.png" alt="image-20230327151727702"></p>
<p>项目结构如下</p>
<p><img src="/img/AcWing/SpringBoot/05Course/image-20230327151811931.png" alt="image-20230327151811931"></p>
<h4 id="创建子项目Backend"><a href="#创建子项目Backend" class="headerlink" title="创建子项目Backend"></a>创建子项目Backend</h4><p>同样的方法创建一个新的Module：<code>backend</code></p>
<p>将之前实现的backend中的src以及pom.xml中的依赖复制到新的模块中</p>
<p>项目结构如下：</p>
<p><img src="/img/AcWing/SpringBoot/05Course/image-20230327154419855.png" alt="image-20230327154419855"></p>
<p>pom.xml文件内容如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>backendcloud<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.kob<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.kob.backend<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>backend<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.springframework.boot/spring-boot-starter-jdbc --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-jdbc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.7.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.projectlombok/lombok --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.18.24<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- https://mvnrepository.com/artifact/mysql/mysql-connector-java --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>8.0.29<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- https://mvnrepository.com/artifact/com.baomidou/mybatis-plus-boot-starter --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.baomidou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.5.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- https://mvnrepository.com/artifact/com.baomidou/mybatis-plus-generator --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.baomidou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-plus-generator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.5.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.springframework.boot/spring-boot-starter-security --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.7.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- https://mvnrepository.com/artifact/io.jsonwebtoken/jjwt-api --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.jsonwebtoken<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jjwt-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.11.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- https://mvnrepository.com/artifact/io.jsonwebtoken/jjwt-impl --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.jsonwebtoken<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jjwt-impl<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.11.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- https://mvnrepository.com/artifact/io.jsonwebtoken/jjwt-jackson --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.jsonwebtoken<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jjwt-jackson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.11.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.springframework.boot/spring-boot-starter-websocket --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-websocket<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.7.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- https://mvnrepository.com/artifact/com.alibaba.fastjson2/fastjson2 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.fastjson2<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>fastjson2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0.11<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-thymeleaf<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="实现匹配系统matchingsystem"><a href="#实现匹配系统matchingsystem" class="headerlink" title="实现匹配系统matchingsystem"></a>实现匹配系统matchingsystem</h2><h3 id="pom配置"><a href="#pom配置" class="headerlink" title="pom配置"></a>pom配置</h3><p>将<code>backendcloud</code>的<code>pom.xml</code>中的<code>dependencies</code>剪切至<code>matchingsystem</code>中的<code>pom.xml</code></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>backendcloud<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.kob<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.kob.matchingsystem<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>matchingsystem<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.springframework.cloud/spring-cloud-dependencies --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2021.0.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="项目端口配置"><a href="#项目端口配置" class="headerlink" title="项目端口配置"></a>项目端口配置</h3><p>在<code>matchingsystem/src/main/resources/application.properties</code>中配置</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server.port</span>=<span class="string">3001</span></span><br></pre></td></tr></table></figure>
<h3 id="matchingsystem匹配代码实现"><a href="#matchingsystem匹配代码实现" class="headerlink" title="matchingsystem匹配代码实现"></a>matchingsystem匹配代码实现</h3><h4 id="添加-移除玩家代码实现"><a href="#添加-移除玩家代码实现" class="headerlink" title="添加/移除玩家代码实现"></a>添加/移除玩家代码实现</h4><ul>
<li>实现匹配的service接口<code>matchingsystem/service/MatchingService</code></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kob.matchingsystem.service;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> xzt</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MatchingService</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">addPlayer</span><span class="params">(Integer userId, Integer rating)</span>;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">removePlayer</span><span class="params">(Integer userId)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>实现对应的实现类<code>matchingsystem/service/impl/MatchingServiceImpl</code>。这边只是简单输出一些信息，用来判断功能是否可用。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kob.matchingsystem.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.kob.matchingsystem.service.MatchingService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> xzt</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MatchingServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">MatchingService</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">addPlayer</span><span class="params">(Integer userId, Integer rating)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;add Player&quot;</span> + userId + <span class="string">&quot; &quot;</span> + rating);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;add player success&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">removePlayer</span><span class="params">(Integer userId)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;remove player&quot;</span> + userId);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;remove player success&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>实现controller, <code>matchingsystem/controller/MatchingController</code>，这边接收参数需要使用<code>MultiValueMap</code></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kob.matchingsystem.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.kob.matchingsystem.service.MatchingService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.MultiValueMap;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Objects;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> xzt</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/player&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MatchingController</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MatchingService matchingService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/add&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">addPlayer</span><span class="params">(<span class="meta">@RequestParam</span> MultiValueMap&lt;String, String&gt; data)</span> &#123;</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">userId</span> <span class="operator">=</span> Integer.parseInt(Objects.requireNonNull(data.getFirst(<span class="string">&quot;user_id&quot;</span>)));</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">rating</span> <span class="operator">=</span> Integer.parseInt(Objects.requireNonNull(data.getFirst(<span class="string">&quot;rating&quot;</span>)));</span><br><span class="line">        <span class="keyword">return</span> matchingService.addPlayer(userId, rating);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/remove&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">removePlayer</span><span class="params">(<span class="meta">@RequestParam</span> MultiValueMap&lt;String, String&gt; data)</span> &#123;</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">userId</span> <span class="operator">=</span> Integer.parseInt(Objects.requireNonNull(data.getFirst(<span class="string">&quot;user_id&quot;</span>)));</span><br><span class="line">        <span class="keyword">return</span> matchingService.removePlayer(userId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="恶意链接拦截"><a href="#恶意链接拦截" class="headerlink" title="恶意链接拦截"></a>恶意链接拦截</h4><p>这里只允许通过本地的链接（127.0.0.1）进行访问，防止恶意访问</p>
<ul>
<li>导入spring security依赖包</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.springframework.boot/spring-boot-starter-security --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.7.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>编写<code>matchingsystem/config/SecurityConfig</code>配置类</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kob.matchingsystem.config;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpMethod;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.builders.HttpSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.http.SessionCreationPolicy;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> xzt</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * 实现用户密码的加密存储, 放行登录，注册等接口</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        http.csrf().disable()</span><br><span class="line">                .sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS)</span><br><span class="line">                .and()</span><br><span class="line">                .authorizeRequests()</span><br><span class="line">                .antMatchers(<span class="string">&quot;/player/add/&quot;</span>, <span class="string">&quot;/player/remove/&quot;</span>).hasIpAddress(<span class="string">&quot;127.0.0.1&quot;</span>)  <span class="comment">// 只允许本地访问</span></span><br><span class="line">                .antMatchers(HttpMethod.OPTIONS).permitAll()</span><br><span class="line">                .anyRequest().authenticated();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="backend匹配代码改写"><a href="#backend匹配代码改写" class="headerlink" title="backend匹配代码改写"></a>backend匹配代码改写</h3><ul>
<li><p>实现一个<code>backend/config/RestTemplateConfig</code>，用来返回一个<code>RestTemplate</code>对象，【RestTemplate 可以在两个spring boot之间进行通讯】，实现微服务通讯</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kob.backend.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.client.RestTemplate;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> xzt</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RestTemplateConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RestTemplate <span class="title function_">getRestTemplate</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// RestTemplate 可以在两个spring boot之间进行通讯</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RestTemplate</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>在<code>backend/consumer/WebSocketServer</code>引入<code>RestTemplate</code>对象</p>
</li>
<li><p>首先修改数据库，将<code>rating</code>字段放在<code>user</code>表中，而不放在<code>bot</code>表中。需要修改对应的实现类<code>Bot</code>和<code>User</code>，同时需要修改对应的一些类<code>register</code>、<code>updateBot</code>、<code>addBot</code>。</p>
</li>
<li>然后修改<code>backend/consumer/WebSocketServer</code>，将匹配成功 后生成地图、启动线程以及像前端发送消息单独放在一个函数中<code>startGame</code>，（之前实在<code>startMatching</code>函数中）</li>
<li>将所有有关<code>matchpool</code>(之前实现的模拟线程池)的操作删除，因为我们需要使用匹配系统微服务进行实现，需要删除的函数包括<code>onClose</code>、<code>stopMatching</code>、<code>startMatching</code></li>
<li>实现对应的参数设置以及使用<code>RestTemplate</code>对象进行匹配系统之间的通讯。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> RestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setRestTemplate</span><span class="params">(RestTemplate restTemplate)</span> &#123;</span><br><span class="line">    WebSocketServer.restTemplate = restTemplate;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@OnClose</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClose</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 关闭链接</span></span><br><span class="line">    System.out.println(<span class="string">&quot;disconnected!&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">this</span>.user != <span class="literal">null</span>) &#123;</span><br><span class="line">        users.remove(<span class="built_in">this</span>.user.getId());</span><br><span class="line">        MultiValueMap&lt;String, String&gt; data = <span class="keyword">new</span> <span class="title class_">LinkedMultiValueMap</span>&lt;&gt;();</span><br><span class="line">        data.add(<span class="string">&quot;user_id&quot;</span>, <span class="built_in">this</span>.user.getId().toString());</span><br><span class="line">        restTemplate.postForObject(removePlayerUrl, data, String.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 匹配成功后，开始游戏前做的内容</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> aId</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> bId</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">startGame</span><span class="params">(Integer aId, Integer bId)</span> &#123;</span><br><span class="line">    <span class="type">User</span> <span class="variable">a</span> <span class="operator">=</span> userMapper.selectById(aId);</span><br><span class="line">    <span class="type">User</span> <span class="variable">b</span> <span class="operator">=</span> userMapper.selectById(bId);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 生成地图</span></span><br><span class="line">    <span class="type">Game</span> <span class="variable">game</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Game</span>(<span class="number">13</span>, <span class="number">14</span>, <span class="number">20</span>, a.getId(), b.getId());</span><br><span class="line">    game.createMap();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 启动一个线程，</span></span><br><span class="line">    game.start();</span><br><span class="line">    users.get(a.getId()).game = game;</span><br><span class="line">    users.get(b.getId()).game = game;</span><br><span class="line"></span><br><span class="line">    <span class="type">JSONObject</span> <span class="variable">respGame</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line">    respGame.put(<span class="string">&quot;a_id&quot;</span>, game.getPlayerA().getId());</span><br><span class="line">    respGame.put(<span class="string">&quot;a_sx&quot;</span>, game.getPlayerA().getSx());</span><br><span class="line">    respGame.put(<span class="string">&quot;a_sy&quot;</span>, game.getPlayerA().getSy());</span><br><span class="line">    respGame.put(<span class="string">&quot;b_id&quot;</span>, game.getPlayerB().getId());</span><br><span class="line">    respGame.put(<span class="string">&quot;b_sx&quot;</span>, game.getPlayerB().getSx());</span><br><span class="line">    respGame.put(<span class="string">&quot;b_sy&quot;</span>, game.getPlayerB().getSy());</span><br><span class="line">    respGame.put(<span class="string">&quot;map&quot;</span>, game.getG());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 往前端传递匹配成功的信息</span></span><br><span class="line">    <span class="type">JSONObject</span> <span class="variable">respA</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line">    respA.put(<span class="string">&quot;event&quot;</span>, <span class="string">&quot;success-matching&quot;</span>);</span><br><span class="line">    respA.put(<span class="string">&quot;opponent_username&quot;</span>, b.getUsername());</span><br><span class="line">    respA.put(<span class="string">&quot;opponent_photo&quot;</span>, b.getPhoto());</span><br><span class="line">    respA.put(<span class="string">&quot;game&quot;</span>, respGame);</span><br><span class="line">    <span class="comment">// 获取A的webSocket，并向前端发送信息</span></span><br><span class="line">    <span class="type">WebSocketServer</span> <span class="variable">webSocketServerA</span> <span class="operator">=</span> users.get(a.getId());</span><br><span class="line">    webSocketServerA.sendMessage(respA.toJSONString());</span><br><span class="line"></span><br><span class="line">    <span class="type">JSONObject</span> <span class="variable">respB</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line">    respB.put(<span class="string">&quot;event&quot;</span>, <span class="string">&quot;success-matching&quot;</span>);</span><br><span class="line">    respB.put(<span class="string">&quot;opponent_username&quot;</span>, a.getUsername());</span><br><span class="line">    respB.put(<span class="string">&quot;opponent_photo&quot;</span>, a.getPhoto());</span><br><span class="line">    respB.put(<span class="string">&quot;game&quot;</span>, respGame);</span><br><span class="line">    <span class="comment">//获取B的webSocket并向前端发送信息</span></span><br><span class="line">    users.get(b.getId()).sendMessage(respB.toJSONString());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 开始匹配函数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">startMatching</span><span class="params">()</span> &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;start matching&quot;</span>);</span><br><span class="line">    MultiValueMap&lt;String, String&gt; data = <span class="keyword">new</span> <span class="title class_">LinkedMultiValueMap</span>&lt;&gt;();</span><br><span class="line">    data.add(<span class="string">&quot;user_id&quot;</span>, <span class="built_in">this</span>.user.getId().toString());</span><br><span class="line">    data.add(<span class="string">&quot;rating&quot;</span>, <span class="built_in">this</span>.user.getRating().toString());</span><br><span class="line">    restTemplate.postForObject(addPlayerUrl, data, String.class);  <span class="comment">// 向matchingsystem发送请求 （请求链接，请求参数，返回值类型）</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 取消匹配</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">stopMatching</span><span class="params">()</span> &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;stop matching&quot;</span>);</span><br><span class="line">    MultiValueMap&lt;String, String&gt; data = <span class="keyword">new</span> <span class="title class_">LinkedMultiValueMap</span>&lt;&gt;();</span><br><span class="line">    data.add(<span class="string">&quot;user_id&quot;</span>, <span class="built_in">this</span>.user.getId().toString());</span><br><span class="line">    restTemplate.postForObject(removePlayerUrl, data, String.class);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="实现效果-7"><a href="#实现效果-7" class="headerlink" title="实现效果"></a>实现效果</h3><p>点击开始匹配后，调用<code>/player/add/</code>，输出对应的信息</p>
<p><img src="/img/AcWing/SpringBoot/05Course/image-20230327162358566.png" alt="image-20230327162358566"></p>
<p>点击取消匹配后，调用<code>/player/remove</code>，输出对应的信息</p>
<p><img src="/img/AcWing/SpringBoot/05Course/image-20230327162434446.png" alt="image-20230327162434446"></p>
<h2 id="匹配系统业务逻辑实现"><a href="#匹配系统业务逻辑实现" class="headerlink" title="匹配系统业务逻辑实现"></a>匹配系统业务逻辑实现</h2><p>需要实现<code>matchingsystem/service/impl/MatchingServiceImpl</code>中的两个方法。</p>
<blockquote>
<p>这里的匹配逻辑是：当接收一个玩家发送匹配请求后，将玩家信息存入一个池子（数组）中，开一个新的线程，每隔1s扫描一遍整个数组，将能够匹配的玩家匹配在一起。</p>
<p>匹配的时候需要将两名分值比较接近的玩家匹配在一起。随着时间的推移，两名玩家允许的分差可以越来越大。同时等待时间长的人优先匹配.</p>
</blockquote>
<h3 id="代码实现-1"><a href="#代码实现-1" class="headerlink" title="代码实现"></a>代码实现</h3><ul>
<li>首先在<code>matchingsystem/service/impl/utils</code>中实现一个类<code>Player</code>，用来保存正在参加匹配的用户的信息</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kob.matchingsystem.service.impl.utils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> xzt</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Player</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Integer userId;</span><br><span class="line">    <span class="keyword">private</span> Integer rating;</span><br><span class="line">    <span class="keyword">private</span> Integer waitingTime; <span class="comment">// 等待时间</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li>在<code>matchingsystem</code>中实现一个线程池，用来保存所有正在匹配的用户信息，<ul>
<li>实现<code>matchingsystem/service/utils/MatchingPool</code>类，需要继承Thread类，实现多线程。</li>
<li>使用<code>List&lt;Player&gt;</code>来保存所有正在匹配的用户。因为可能被多个线程同时读写，因此需要定义一个锁<code>ReentrantLock</code>，用来保证读写不冲突。</li>
<li>重写<code>Thread</code>类中的<code>run</code>方法。用来每秒循环一次，每次循环需要通过<code>increaseWaitingTime</code>函数实现每个正在匹配的用户的等待时间加1，然后调用<code>matchPlayers</code>函数进行玩家匹配。</li>
<li><code>increaseWaitingTime</code>函数：就是循环遍历一遍所有正在匹配的用户，给每个用户的等待时间加1即可。</li>
<li><code>matchPlayers</code>函数：首先定义一个布尔类型的数组，用来保存哪个用户已经匹配成功。然后双层循环遍历，判断两两玩家是否匹配，若都没有匹配，则调用<code>checkMatch</code>函数进行判断当前两个用户是否可以匹配。如果可以匹配，则通过<code>sendResult</code>函数向<code>backend</code>发送匹配的玩家的消息。最后将匹配成功的用户从<code>List</code>中移除</li>
<li><code>checkMatch</code>函数：首先计算两个用户<code>rating</code>差值，只有当用户的战力差小于等于两个玩家中最小的等待时间*10才能匹配成功。</li>
<li><code>sendResult</code>函数：定义一个<code>MultiValueMap</code>来保存匹配成功的两个用户的id，并通过<code>restTemplate</code>向<code>backend</code>发送.<ul>
<li>这里需要导入<code>matchingsystem/config/RestTemplate</code>类。</li>
</ul>
</li>
<li>在<code>matchingsystem/MatchingSystemApplication</code>的主函数中启动匹配线程。⭐意思是当这个服务启动时，就开始每1s检测一下是否存在可以匹配的两个用户。</li>
</ul>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kob.matchingsystem.service.impl.utils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.LinkedMultiValueMap;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.MultiValueMap;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.client.RestTemplate;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.locks.ReentrantLock;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> xzt</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MatchingPool</span> <span class="keyword">extends</span> <span class="title class_">Thread</span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> List&lt;Player&gt; players = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();  <span class="comment">// 多个线程调用，涉及读写冲突</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">ReentrantLock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> RestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">startGameUrl</span> <span class="operator">=</span> <span class="string">&quot;http://127.0.0.1:3000/pk/game/start/&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setRestTemplate</span><span class="params">(RestTemplate restTemplate)</span> &#123;</span><br><span class="line">        MatchingPool.restTemplate = restTemplate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addPlayer</span><span class="params">(Integer userId, Integer rating)</span> &#123;</span><br><span class="line">        lock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            players.add(<span class="keyword">new</span> <span class="title class_">Player</span>(userId, rating, <span class="number">0</span>));</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">removePlayer</span><span class="params">(Integer userId)</span> &#123;</span><br><span class="line">        lock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            List&lt;Player&gt; newPlayers = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">            <span class="keyword">for</span> (Player player : players) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!player.getUserId().equals(userId)) &#123;</span><br><span class="line">                    newPlayers.add(player);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            players = newPlayers;</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 将所有玩家的等待时间加1</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">increaseWaitingTime</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">for</span>(Player player : players ) &#123;</span><br><span class="line">            player.setWaitingTime(player.getWaitingTime() + <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 判断两名玩家是否匹配</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> a 玩家a</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> b 玩家b</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> true 已匹配，false未匹配</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">checkMatch</span><span class="params">(Player a, Player b)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">ratingDelta</span> <span class="operator">=</span> Math.abs(a.getRating() - b.getRating());</span><br><span class="line">        <span class="comment">// 分差需要能被a和b都接收，因此需要保证分差小于a和b的等待时间*10的最小值</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">waitingTime</span> <span class="operator">=</span> Math.min(a.getWaitingTime(), b.getWaitingTime());</span><br><span class="line">        <span class="keyword">return</span> ratingDelta &lt;= waitingTime * <span class="number">10</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 返回a和b的匹配结果</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> a</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> b</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">sendResult</span><span class="params">(Player a, Player b)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;send result: &quot;</span> + a + <span class="string">&quot; &quot;</span> + b);</span><br><span class="line">        MultiValueMap&lt;String, String&gt; data = <span class="keyword">new</span> <span class="title class_">LinkedMultiValueMap</span>&lt;&gt;();</span><br><span class="line">        data.add(<span class="string">&quot;a_id&quot;</span>, a.getUserId().toString());</span><br><span class="line">        data.add(<span class="string">&quot;b_id&quot;</span>, b.getUserId().toString());</span><br><span class="line">        restTemplate.postForObject(startGameUrl, data, String.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 尝试匹配所有玩家，优先匹配等待时间久的玩家，也就是下标小的玩家</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">matchPlayers</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;match players: &quot;</span> + players.toString());</span><br><span class="line">        <span class="type">boolean</span>[] used = <span class="keyword">new</span> <span class="title class_">boolean</span>[players.size()];</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; players.size(); i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (used[i]) <span class="keyword">continue</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> i + <span class="number">1</span>; j &lt; players.size(); j++) &#123;</span><br><span class="line">                <span class="keyword">if</span>(used[j]) <span class="keyword">continue</span>;</span><br><span class="line">                <span class="type">Player</span> <span class="variable">a</span> <span class="operator">=</span> players.get(i), b = players.get(j);</span><br><span class="line">                <span class="keyword">if</span>(checkMatch(a, b)) &#123;</span><br><span class="line">                    used[i] = used[j] = <span class="literal">true</span>;</span><br><span class="line">                    sendResult(a, b);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 将匹配成功的玩家删除</span></span><br><span class="line">        List&lt;Player&gt; newPlayers = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; players.size(); i++) &#123;</span><br><span class="line">            <span class="keyword">if</span>(!used[i])</span><br><span class="line">                newPlayers.add(players.get(i));</span><br><span class="line">        &#125;</span><br><span class="line">        players = newPlayers;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">while</span>(<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">                lock.lock();</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    increaseWaitingTime();</span><br><span class="line">                    matchPlayers();</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    lock.unlock();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><p>在backend中实现：</p>
<ul>
<li><p>首先修改<code>backend/config/SecurityConfig</code>中的<code>configure</code>函数，将<code>/pk/game/start</code>链接方向，并且只能通过本地访问。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    http.csrf().disable()</span><br><span class="line">        .sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS)</span><br><span class="line">        .and()</span><br><span class="line">        .authorizeRequests()</span><br><span class="line">        .antMatchers(<span class="string">&quot;/user/account/token/&quot;</span>, <span class="string">&quot;/user/account/register/&quot;</span>).permitAll()</span><br><span class="line">        .antMatchers(<span class="string">&quot;/pk/game/start/&quot;</span>).hasIpAddress(<span class="string">&quot;127.0.0.1&quot;</span>)</span><br><span class="line">        .antMatchers(HttpMethod.OPTIONS).permitAll()</span><br><span class="line">        .anyRequest().authenticated();</span><br><span class="line"></span><br><span class="line">    http.addFilterBefore(jwtAuthenticationTokenFilter, UsernamePasswordAuthenticationFilter.class);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>实现对应的<code>backeng/service/pk/StartGameService</code>以及<code>backend/service/impl/pk/StartGameServiceImpl</code>，在<code>StartGameServiceImpl</code>中通过传来的匹配成功的两个玩家的id，然后调用<code>WebSocketServer.startGame</code>函数，生成地图、向前端返回等一系列操作。这里需要把<code>startGame</code>函数变为<code>public static</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kob.backend.service.pk;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> xzt</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">StartGameService</span> &#123;</span><br><span class="line">    String <span class="title function_">startGame</span><span class="params">(Integer aId, Integer bId)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kob.backend.service.impl.pk;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.kob.backend.consumer.WebSocketServer;</span><br><span class="line"><span class="keyword">import</span> com.kob.backend.service.pk.StartGameService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> xzt</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StartGameServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">StartGameService</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">startGame</span><span class="params">(Integer aId, Integer bId)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;start game: &quot;</span> + aId + <span class="string">&quot; &quot;</span> + bId);</span><br><span class="line">        WebSocketServer.startGame(aId, bId);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;start game success&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>实现<code>backend/controller/pk/StartGameController</code>，接收从<code>matchingsystem</code>中传来的id</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kob.backend.controller.pk;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.kob.backend.service.pk.StartGameService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.MultiValueMap;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Objects;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> xzt</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/pk&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StartGameController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> StartGameService startGameService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/game/start&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">startGame</span><span class="params">(<span class="meta">@RequestParam</span> MultiValueMap&lt;String, String&gt; data)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">aId</span> <span class="operator">=</span> Integer.parseInt(Objects.requireNonNull(data.getFirst(<span class="string">&quot;a_id&quot;</span>)));</span><br><span class="line">        <span class="type">int</span> <span class="variable">bId</span> <span class="operator">=</span> Integer.parseInt(Objects.requireNonNull(data.getFirst(<span class="string">&quot;b_id&quot;</span>)));</span><br><span class="line">        <span class="keyword">return</span> startGameService.startGame(aId, bId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<h3 id="实现效果-8"><a href="#实现效果-8" class="headerlink" title="实现效果"></a>实现效果</h3><p>这里将用户qqy的rating改为了1400，用户xzt的rating为1500，因此理论来说需要匹配10s才能匹配成功。</p>
<p><img src="/img/AcWing/SpringBoot/05Course/image-20230327200752649.png" alt="image-20230327200752649"></p>
<p>可以看到，10s后匹配成功了。并且当匹配成功后，匹配池会将匹配成功的两名玩家删除。</p>
<p><img src="/img/AcWing/SpringBoot/05Course/image-20230327200822695.png" alt="image-20230327200822695"></p>
<h2 id="业务逻辑优化"><a href="#业务逻辑优化" class="headerlink" title="业务逻辑优化"></a>业务逻辑优化</h2><h3 id="存在的问题"><a href="#存在的问题" class="headerlink" title="存在的问题"></a>存在的问题</h3><p>当两名玩家正在匹配，此时其中一名玩家将匹配页面直接关闭，但是匹配池中还会存在，这个时候另一个玩家就不会匹配成功，并且会在后台报异常。</p>
<p>这是因此如果关闭页面则该用户的<code>users</code>就不存在，所以需要在<code>backend</code>中的所有存在<code>users.get</code>位置加上判断。</p>
<ul>
<li>修改<code>backend/consumer/WebSocketServer</code>中的<code>startGame</code>函数</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 匹配成功后，开始游戏前做的内容</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> aId 玩家1id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> bId 玩家2id</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">startGame</span><span class="params">(Integer aId, Integer bId)</span> &#123;</span><br><span class="line">    <span class="type">User</span> <span class="variable">a</span> <span class="operator">=</span> userMapper.selectById(aId);</span><br><span class="line">    <span class="type">User</span> <span class="variable">b</span> <span class="operator">=</span> userMapper.selectById(bId);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 生成地图</span></span><br><span class="line">    <span class="type">Game</span> <span class="variable">game</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Game</span>(<span class="number">13</span>, <span class="number">14</span>, <span class="number">20</span>, a.getId(), b.getId());</span><br><span class="line">    game.createMap();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 启动一个线程，</span></span><br><span class="line">    game.start();</span><br><span class="line">    <span class="keyword">if</span> (users.get(a.getId()) != <span class="literal">null</span>)</span><br><span class="line">        users.get(a.getId()).game = game;</span><br><span class="line">    <span class="keyword">if</span> (users.get(b.getId()) != <span class="literal">null</span>)</span><br><span class="line">        users.get(b.getId()).game = game;</span><br><span class="line"></span><br><span class="line">    <span class="type">JSONObject</span> <span class="variable">respGame</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line">    respGame.put(<span class="string">&quot;a_id&quot;</span>, game.getPlayerA().getId());</span><br><span class="line">    respGame.put(<span class="string">&quot;a_sx&quot;</span>, game.getPlayerA().getSx());</span><br><span class="line">    respGame.put(<span class="string">&quot;a_sy&quot;</span>, game.getPlayerA().getSy());</span><br><span class="line">    respGame.put(<span class="string">&quot;b_id&quot;</span>, game.getPlayerB().getId());</span><br><span class="line">    respGame.put(<span class="string">&quot;b_sx&quot;</span>, game.getPlayerB().getSx());</span><br><span class="line">    respGame.put(<span class="string">&quot;b_sy&quot;</span>, game.getPlayerB().getSy());</span><br><span class="line">    respGame.put(<span class="string">&quot;map&quot;</span>, game.getG());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 往前端传递匹配成功的信息</span></span><br><span class="line">    <span class="type">JSONObject</span> <span class="variable">respA</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line">    respA.put(<span class="string">&quot;event&quot;</span>, <span class="string">&quot;success-matching&quot;</span>);</span><br><span class="line">    respA.put(<span class="string">&quot;opponent_username&quot;</span>, b.getUsername());</span><br><span class="line">    respA.put(<span class="string">&quot;opponent_photo&quot;</span>, b.getPhoto());</span><br><span class="line">    respA.put(<span class="string">&quot;game&quot;</span>, respGame);</span><br><span class="line">    <span class="comment">// 获取A的webSocket，并向前端发送信息</span></span><br><span class="line">    <span class="keyword">if</span>(users.get(a.getId()) != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="type">WebSocketServer</span> <span class="variable">webSocketServerA</span> <span class="operator">=</span> users.get(a.getId());</span><br><span class="line">        webSocketServerA.sendMessage(respA.toJSONString());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">JSONObject</span> <span class="variable">respB</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line">    respB.put(<span class="string">&quot;event&quot;</span>, <span class="string">&quot;success-matching&quot;</span>);</span><br><span class="line">    respB.put(<span class="string">&quot;opponent_username&quot;</span>, a.getUsername());</span><br><span class="line">    respB.put(<span class="string">&quot;opponent_photo&quot;</span>, a.getPhoto());</span><br><span class="line">    respB.put(<span class="string">&quot;game&quot;</span>, respGame);</span><br><span class="line">    <span class="comment">//获取B的webSocket并向前端发送信息</span></span><br><span class="line">    <span class="keyword">if</span>(users.get(b.getId()) != <span class="literal">null</span>)</span><br><span class="line">        users.get(b.getId()).sendMessage(respB.toJSONString());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>修改<code>backend/consumer/utils/Game</code>中的<code>sendAllMessage</code>函数</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 向所有玩家发送信息</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">sendAllMessage</span><span class="params">(String message)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span>(WebSocketServer.users.get(playerA.getId()) != <span class="literal">null</span>)</span><br><span class="line">        WebSocketServer.users.get(playerA.getId()).sendMessage(message); <span class="comment">// 这里的sendMessage是WebSocketServer里的</span></span><br><span class="line">    <span class="keyword">if</span>(WebSocketServer.users.get(playerB.getId()) != <span class="literal">null</span>)</span><br><span class="line">        WebSocketServer.users.get(playerB.getId()).sendMessage(message);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Atopos·</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://example.com/2023/03/17/AcWing/SpringBoot/05Course/">http://example.com/2023/03/17/AcWing/SpringBoot/05Course/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://example.com" target="_blank">Atopos's Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/JAVA/">JAVA</a><a class="post-meta__tags" href="/tags/SpringBoot/">SpringBoot</a><a class="post-meta__tags" href="/tags/AcWing/">AcWing</a></div><div class="post_share"><div class="social-share" data-image="https://cdn.acwing.com/media/activity/surface/springbootlesson.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/wechat.jpg" target="_blank"><img class="post-qr-code-img" src="/img/wechat.jpg" alt="微信"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="/img/alipay.jpg" target="_blank"><img class="post-qr-code-img" src="/img/alipay.jpg" alt="支付宝"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2023/03/25/AcWing/SpringBoot/06Course/"><img class="prev-cover" src="https://cdn.acwing.com/media/activity/surface/springbootlesson.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">AcWing SpringBoot项目实战06</div></div></a></div><div class="next-post pull-right"><a href="/2023/03/14/AcWing/SpringBoot/04Course/"><img class="next-cover" src="https://cdn.acwing.com/media/activity/surface/springbootlesson.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">AcWing SpringBoot项目实战04</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2022/06/29/AcWing/SpringCourse/" title="AcWing SpringBoot框架课"><img class="cover" src="https://cdn.acwing.com/media/activity/surface/springbootlesson.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-06-29</div><div class="title">AcWing SpringBoot框架课</div></div></a></div><div><a href="/2023/03/07/AcWing/SpringBoot/01Course/" title="AcWing SpringBoot项目实战01"><img class="cover" src="https://cdn.acwing.com/media/activity/surface/springbootlesson.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-03-07</div><div class="title">AcWing SpringBoot项目实战01</div></div></a></div><div><a href="/2023/03/07/AcWing/SpringBoot/02Course/" title="AcWing SpringBoot项目实战02"><img class="cover" src="https://cdn.acwing.com/media/activity/surface/springbootlesson.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-03-07</div><div class="title">AcWing SpringBoot项目实战02</div></div></a></div><div><a href="/2023/03/09/AcWing/SpringBoot/03Course/" title="AcWing SpringBoot项目实战03"><img class="cover" src="https://cdn.acwing.com/media/activity/surface/springbootlesson.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-03-09</div><div class="title">AcWing SpringBoot项目实战03</div></div></a></div><div><a href="/2023/03/14/AcWing/SpringBoot/04Course/" title="AcWing SpringBoot项目实战04"><img class="cover" src="https://cdn.acwing.com/media/activity/surface/springbootlesson.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-03-14</div><div class="title">AcWing SpringBoot项目实战04</div></div></a></div><div><a href="/2023/03/25/AcWing/SpringBoot/06Course/" title="AcWing SpringBoot项目实战06"><img class="cover" src="https://cdn.acwing.com/media/activity/surface/springbootlesson.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-03-25</div><div class="title">AcWing SpringBoot项目实战06</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/./img/head.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Atopos·</div><div class="author-info__description">看得懂的书,请仔细看;看不懂的书,请硬着头皮看!</div></div><div class="card-info-data is-center"><div class="card-info-data-item"><a href="/archives/"><div class="headline">文章</div><div class="length-num">88</div></a></div><div class="card-info-data-item"><a href="/tags/"><div class="headline">标签</div><div class="length-num">57</div></a></div><div class="card-info-data-item"><a href="/categories/"><div class="headline">分类</div><div class="length-num">15</div></a></div></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/Xzt-hub"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/aaaatopos" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:xzt2520@163.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">学习使用新博客</div></div><div class="sticky_clock"></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0"><span class="toc-number">1.</span> <span class="toc-text">学习平台</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%B3%BB%E7%BB%9F%E6%B5%81%E7%A8%8B"><span class="toc-number">2.</span> <span class="toc-text">系统流程</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%94%B9%E8%BF%9B%E4%B9%8B%E5%A4%84"><span class="toc-number">3.</span> <span class="toc-text">改进之处</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE"><span class="toc-number">4.</span> <span class="toc-text">环境配置</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9B%86%E6%88%90WebSocket"><span class="toc-number">4.1.</span> <span class="toc-text">集成WebSocket</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E7%AB%AF%E5%AE%9E%E7%8E%B0"><span class="toc-number">4.2.</span> <span class="toc-text">前端实现</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81jwt"><span class="toc-number">4.3.</span> <span class="toc-text">验证jwt</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8C%B9%E9%85%8D%E7%95%8C%E9%9D%A2%E5%89%8D%E7%AB%AF%E5%AE%9E%E7%8E%B0"><span class="toc-number">5.</span> <span class="toc-text">匹配界面前端实现</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%95%8C%E9%9D%A2%E5%B8%83%E5%B1%80"><span class="toc-number">5.1.</span> <span class="toc-text">界面布局</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E7%AB%AF%E5%AE%9E%E7%8E%B0-1"><span class="toc-number">5.2.</span> <span class="toc-text">前端实现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E6%AD%A5%E9%AA%A4"><span class="toc-number">5.2.1.</span> <span class="toc-text">实现步骤</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E6%95%88%E6%9E%9C"><span class="toc-number">5.2.2.</span> <span class="toc-text">实现效果</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8C%B9%E9%85%8D%E7%95%8C%E9%9D%A2%E5%90%8E%E7%AB%AF%E5%AE%9E%E7%8E%B0"><span class="toc-number">6.</span> <span class="toc-text">匹配界面后端实现</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E6%AD%A5%E9%AA%A4-1"><span class="toc-number">6.1.</span> <span class="toc-text">实现步骤</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E5%82%BB%E7%93%9C%E5%BC%8F%E5%8C%B9%E9%85%8D"><span class="toc-number">6.2.</span> <span class="toc-text">实现傻瓜式匹配</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E6%AD%A5%E9%AA%A4-2"><span class="toc-number">6.2.1.</span> <span class="toc-text">实现步骤</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E6%95%88%E6%9E%9C-1"><span class="toc-number">6.2.2.</span> <span class="toc-text">实现效果</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%9F%E6%88%90%E5%9C%B0%E5%9B%BE%E4%BC%98%E5%8C%96%EF%BC%88%E5%90%8C%E6%AD%A5%EF%BC%89"><span class="toc-number">6.3.</span> <span class="toc-text">生成地图优化（同步）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E6%AD%A5%E9%AA%A4-3"><span class="toc-number">6.3.1.</span> <span class="toc-text">实现步骤</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E6%95%88%E6%9E%9C-2"><span class="toc-number">6.3.2.</span> <span class="toc-text">实现效果</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E7%8E%A9%E5%AE%B6%E7%9A%84%E4%BD%8D%E7%BD%AE%E5%90%8C%E6%AD%A5"><span class="toc-number">6.4.</span> <span class="toc-text">实现玩家的位置同步</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E6%AD%A5%E9%AA%A4-4"><span class="toc-number">6.4.1.</span> <span class="toc-text">实现步骤</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%8E%E7%AB%AF%E5%AE%9E%E7%8E%B0"><span class="toc-number">6.4.1.1.</span> <span class="toc-text">后端实现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%89%8D%E7%AB%AF%E5%AE%9E%E7%8E%B0-2"><span class="toc-number">6.4.1.2.</span> <span class="toc-text">前端实现</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E6%95%88%E6%9E%9C-3"><span class="toc-number">6.4.2.</span> <span class="toc-text">实现效果</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E8%9B%87%E7%9A%84%E7%A7%BB%E5%8A%A8%EF%BC%88%E5%90%8C%E6%AD%A5%EF%BC%89%E2%AD%90%E2%AD%90"><span class="toc-number">6.5.</span> <span class="toc-text">实现蛇的移动（同步）⭐⭐</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E6%AD%A5%E9%AA%A4-5"><span class="toc-number">6.5.1.</span> <span class="toc-text">实现步骤</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%8E%E7%AB%AF%E5%AE%9E%E7%8E%B0-1"><span class="toc-number">6.5.1.1.</span> <span class="toc-text">后端实现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%89%8D%E7%AB%AF%E5%AE%9E%E7%8E%B0-3"><span class="toc-number">6.5.1.2.</span> <span class="toc-text">前端实现</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E6%95%88%E6%9E%9C-4"><span class="toc-number">6.5.2.</span> <span class="toc-text">实现效果</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B8%B8%E6%88%8F%E7%BB%93%E6%9E%9C%E4%BC%98%E5%8C%96"><span class="toc-number">6.6.</span> <span class="toc-text">游戏结果优化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E6%AD%A5%E9%AA%A4-6"><span class="toc-number">6.6.1.</span> <span class="toc-text">实现步骤</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E6%95%88%E6%9E%9C-5"><span class="toc-number">6.6.2.</span> <span class="toc-text">实现效果</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B8%B8%E6%88%8F%E5%AF%B9%E6%88%98%E8%AE%B0%E5%BD%95%E4%BF%9D%E5%AD%98"><span class="toc-number">6.7.</span> <span class="toc-text">游戏对战记录保存</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E9%85%8D%E7%BD%AE"><span class="toc-number">6.7.1.</span> <span class="toc-text">数据库配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="toc-number">6.7.2.</span> <span class="toc-text">代码实现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E6%95%88%E6%9E%9C-6"><span class="toc-number">6.7.3.</span> <span class="toc-text">实现效果</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F%E7%9A%84%E5%BE%AE%E6%9C%8D%E5%8A%A1%E2%AD%90"><span class="toc-number">7.</span> <span class="toc-text">实现匹配系统的微服务⭐</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E6%A1%86%E6%9E%B6"><span class="toc-number">7.1.</span> <span class="toc-text">项目框架</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BE%AE%E6%9C%8D%E5%8A%A1%E9%A1%B9%E7%9B%AE%E5%88%9B%E5%BB%BA-amp-%E9%85%8D%E7%BD%AE"><span class="toc-number">7.2.</span> <span class="toc-text">微服务项目创建&amp;配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BAspring-cloud%E9%A1%B9%E7%9B%AE"><span class="toc-number">7.2.1.</span> <span class="toc-text">创建spring cloud项目</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AESpring-Cloud%E9%A1%B9%E7%9B%AE"><span class="toc-number">7.2.2.</span> <span class="toc-text">配置Spring Cloud项目</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E5%AD%90%E9%A1%B9%E7%9B%AE"><span class="toc-number">7.2.3.</span> <span class="toc-text">创建子项目</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E5%AD%90%E9%A1%B9%E7%9B%AEmatchingSystem"><span class="toc-number">7.2.3.1.</span> <span class="toc-text">创建子项目matchingSystem</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E5%AD%90%E9%A1%B9%E7%9B%AEBackend"><span class="toc-number">7.2.3.2.</span> <span class="toc-text">创建子项目Backend</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9Fmatchingsystem"><span class="toc-number">7.3.</span> <span class="toc-text">实现匹配系统matchingsystem</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#pom%E9%85%8D%E7%BD%AE"><span class="toc-number">7.3.1.</span> <span class="toc-text">pom配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E7%AB%AF%E5%8F%A3%E9%85%8D%E7%BD%AE"><span class="toc-number">7.3.2.</span> <span class="toc-text">项目端口配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#matchingsystem%E5%8C%B9%E9%85%8D%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="toc-number">7.3.3.</span> <span class="toc-text">matchingsystem匹配代码实现</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0-%E7%A7%BB%E9%99%A4%E7%8E%A9%E5%AE%B6%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="toc-number">7.3.3.1.</span> <span class="toc-text">添加&#x2F;移除玩家代码实现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%81%B6%E6%84%8F%E9%93%BE%E6%8E%A5%E6%8B%A6%E6%88%AA"><span class="toc-number">7.3.3.2.</span> <span class="toc-text">恶意链接拦截</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#backend%E5%8C%B9%E9%85%8D%E4%BB%A3%E7%A0%81%E6%94%B9%E5%86%99"><span class="toc-number">7.3.4.</span> <span class="toc-text">backend匹配代码改写</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E6%95%88%E6%9E%9C-7"><span class="toc-number">7.3.5.</span> <span class="toc-text">实现效果</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F%E4%B8%9A%E5%8A%A1%E9%80%BB%E8%BE%91%E5%AE%9E%E7%8E%B0"><span class="toc-number">7.4.</span> <span class="toc-text">匹配系统业务逻辑实现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0-1"><span class="toc-number">7.4.1.</span> <span class="toc-text">代码实现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E6%95%88%E6%9E%9C-8"><span class="toc-number">7.4.2.</span> <span class="toc-text">实现效果</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%9A%E5%8A%A1%E9%80%BB%E8%BE%91%E4%BC%98%E5%8C%96"><span class="toc-number">7.5.</span> <span class="toc-text">业务逻辑优化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AD%98%E5%9C%A8%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-number">7.5.1.</span> <span class="toc-text">存在的问题</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2023/04/06/JAVA/22Underlying/" title="锁"><img src="/../../img/Review.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="锁"/></a><div class="content"><a class="title" href="/2023/04/06/JAVA/22Underlying/" title="锁">锁</a><time datetime="2023-04-06T00:02:25.000Z" title="发表于 2023-04-06 08:02:25">2023-04-06</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/04/04/JAVA/21Underlying/" title="源码学习"><img src="/../../img/Review.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="源码学习"/></a><div class="content"><a class="title" href="/2023/04/04/JAVA/21Underlying/" title="源码学习">源码学习</a><time datetime="2023-04-04T00:02:25.000Z" title="发表于 2023-04-04 08:02:25">2023-04-04</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/03/30/JAVA/20ReviewNotes/" title="复习笔记"><img src="/../../img/Review.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="复习笔记"/></a><div class="content"><a class="title" href="/2023/03/30/JAVA/20ReviewNotes/" title="复习笔记">复习笔记</a><time datetime="2023-03-30T00:02:25.000Z" title="发表于 2023-03-30 08:02:25">2023-03-30</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/03/29/AcWing/SpringBoot/07Course/" title="AcWing SpringBoot项目实战07"><img src="https://cdn.acwing.com/media/activity/surface/springbootlesson.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="AcWing SpringBoot项目实战07"/></a><div class="content"><a class="title" href="/2023/03/29/AcWing/SpringBoot/07Course/" title="AcWing SpringBoot项目实战07">AcWing SpringBoot项目实战07</a><time datetime="2023-03-29T02:23:23.000Z" title="发表于 2023-03-29 10:23:23">2023-03-29</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/03/27/Question/StrangeQuestion/" title="奇怪的问题&amp;解决方法"><img src="/../../img/problem.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="奇怪的问题&amp;解决方法"/></a><div class="content"><a class="title" href="/2023/03/27/Question/StrangeQuestion/" title="奇怪的问题&amp;解决方法">奇怪的问题&amp;解决方法</a><time datetime="2023-03-27T08:34:29.000Z" title="发表于 2023-03-27 16:34:29">2023-03-27</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2023 By Atopos·</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">Hi, welcome to my <a target="_blank" rel="noopener" href="https://butterfly.js.org/">blog</a>!</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">本地搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/medium-zoom/dist/medium-zoom.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (false){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><script src="/js/search/local-search.js"></script><script>var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',preloader.endLoading())</script><div class="js-pjax"><script>(() => {
  const $mermaidWrap = document.querySelectorAll('#article-container .mermaid-wrap')
  if ($mermaidWrap.length) {
    window.runMermaid = () => {
      window.loadMermaid = true
      const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

      Array.from($mermaidWrap).forEach((item, index) => {
        const mermaidSrc = item.firstElementChild
        const mermaidThemeConfig = '%%{init:{ \'theme\':\'' + theme + '\'}}%%\n'
        const mermaidID = 'mermaid-' + index
        const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent
        mermaid.mermaidAPI.render(mermaidID, mermaidDefinition, (svgCode) => {
          mermaidSrc.insertAdjacentHTML('afterend', svgCode)
        })
      })
    }

    const loadMermaid = () => {
      window.loadMermaid ? runMermaid() : getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(runMermaid)
    }

    window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
  }
})()</script></div><script defer="defer" id="fluttering_ribbon" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-fluttering-ribbon.min.js"></script><script id="click-heart" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/click-heart.min.js" async="async" mobile="false"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><!-- hexo injector body_end start --><script data-pjax>
  function butterfly_clock_injector_config(){
    var parent_div_git = document.getElementsByClassName('sticky_clock')[0];
    var item_html = '<div class="card-widget card-clock"><div class="card-glass"><div class="card-background"><div class="card-content"><div id="hexo_electric_clock"><img class="entered loading" id="card-clock-loading" src="/./img/loading.gif" style="height: 120px; width: 100%;" data-ll-status="loading"/></div></div></div></div></div>';
    console.log('已挂载butterfly_clock')
    parent_div_git.insertAdjacentHTML("afterbegin",item_html)
    }
  var elist = 'null'.split(',');
  var cpage = location.pathname;
  var epage = 'all';
  var flag = 0;

  for (var i=0;i<elist.length;i++){
    if (cpage.includes(elist[i])){
      flag++;
    }
  }

  if ((epage ==='all')&&(flag == 0)){
    butterfly_clock_injector_config();
  }
  else if (epage === cpage){
    butterfly_clock_injector_config();
  }
  </script><script src="https://pv.sohu.com/cityjson?ie=utf-8"></script><script data-pjax src="https://unpkg.zhimg.com/hexo-butterfly-clock/lib/clock.min.js"></script><!-- hexo injector body_end end --></body></html>